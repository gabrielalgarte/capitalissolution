<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Capitalis Solution - Painel Financeiro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script>
        try {
            if(!sessionStorage.getItem('capitalis_session')) {
                window.location.replace('redir.html'); 
            }
        } catch(e) {
            window.location.replace('redir.html');
        }
    </script>

    <style>
        :root {
            --bg-body: #050505; --bg-panel: #0E0F11; --bg-card: #141619; --border-color: #2D333B;
            --primary: #2F81F7; --primary-glow: rgba(47, 129, 247, 0.4); --success: #238636;
            --danger: #F85149; --warning: #e3b341; --info: #a371f7;
            --invest-profit: #00E676; --invest-gold: #FFD700;
            --chart-1: #2F81F7; --chart-2: #00E676; --chart-3: #e3b341; --chart-4: #a371f7;
            --text-main: #E6EDF3; --text-muted: #7D8590; --card-shadow: 0 4px 12px rgba(0,0,0,0.2);
            --input-bg: #0d1117; --logo-fill: #FFFFFF; --nav-hover: rgba(255, 255, 255, 0.03);
            --nav-active-bg: rgba(47, 129, 247, 0.1); --blur-strength: 6px; --modal-bg: rgba(20, 22, 25, 0.98);
        }
        body.light-mode {
            --bg-body: #f0f2f5; --bg-panel: #ffffff; --bg-card: #ffffff; --border-color: #d1d5db;
            --primary: #2563eb; --primary-glow: rgba(37, 99, 235, 0.2); --success: #16a34a;
            --danger: #dc2626; --warning: #d97706; --info: #7c3aed;
            --invest-profit: #10B981; --invest-gold: #D4AF37;
            --chart-1: #2563eb; --chart-2: #16a34a; --chart-3: #d97706; --chart-4: #7c3aed;
            --text-main: #1e293b; --text-muted: #64748b; --card-shadow: 0 4px 15px rgba(0,0,0,0.05);
            --input-bg: #f8fafc; --logo-fill: #1e293b; --nav-hover: rgba(0, 0, 0, 0.05);
            --nav-active-bg: rgba(37, 99, 235, 0.1); --modal-bg: rgba(255, 255, 255, 0.98);
        }
        body.privacy-mode .blur-sensitive { color: transparent !important; text-shadow: 0 0 var(--blur-strength) rgba(128, 128, 128, 0.5); user-select: none; cursor: default; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--text-main); display: flex; min-height: 100vh; overflow-x: hidden; font-size: 15px; transition: background-color 0.3s ease, color 0.3s ease; }
        
        #ptr-loader { position: fixed; top: -60px; left: 50%; transform: translateX(-50%); width: 40px; height: 40px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 50%; z-index: 999; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: top 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #ptr-spinner { width: 20px; height: 20px; border: 2px solid rgba(47, 129, 247, 0.3); border-top: 2px solid var(--primary); border-radius: 50%; }
        .ptr-spinning { animation: ptr-spin 0.8s linear infinite; }
        @keyframes ptr-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        aside { width: 260px; background-color: var(--bg-panel); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 25px 15px 15px 15px; padding-top: 40px; position: fixed; height: 100vh; z-index: 100; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .brand { display: flex; align-items: center; gap: 10px; margin-bottom: 35px; padding-left: 10px; cursor: pointer; }
        .brand-text { font-size: 1.2rem; font-weight: 800; letter-spacing: 0.5px; color: var(--text-main); font-family: 'Inter', sans-serif; }
        .nav-menu { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .nav-item { padding: 10px 14px; border-radius: 8px; color: var(--text-muted); cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 12px; font-weight: 500; font-size: 0.9rem; }
        .nav-item:hover { background: var(--nav-hover); color: var(--text-main); }
        .nav-item.active { background: var(--nav-active-bg); color: var(--primary); border: 1px solid rgba(47, 129, 247, 0.2); }
        .nav-item i { font-size: 1.1rem; }
        .btn-logout { margin-top: auto; color: var(--danger); padding: 10px 14px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 0.9rem; }
        .btn-logout:hover { background: rgba(248, 81, 73, 0.1); }

        main { margin-left: 260px; flex: 1; padding: 30px 40px; width: 100%; padding-top: 50px; transition: transform 0.2s; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; gap: 20px; flex-wrap: wrap; }
        .header-left h1 { font-size: 1.6rem; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 2px; }
        .bio-quote { color: var(--text-muted); font-size: 0.85rem; font-style: italic; border-left: 3px solid var(--primary); padding-left: 10px; }
        .header-right { display: flex; align-items: center; gap: 10px; margin-left: auto; }
        .header-actions { display: flex; gap: 8px; }
        
        .user-badge { display: flex; align-items: center; gap: 10px; background: var(--bg-card); padding: 4px 4px 4px 12px; border-radius: 50px; border: 1px solid var(--border-color); box-shadow: var(--card-shadow); }
        .avatar-circle { width: 32px; height: 32px; background: var(--primary); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; box-shadow: 0 0 8px var(--primary-glow); border: 2px solid var(--bg-panel); }
        
        .icon-btn { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: var(--card-shadow); transition: all 0.3s; color: var(--text-main); position: relative; font-size: 1.1rem; }
        .icon-btn:hover { transform: scale(1.05); color: var(--primary); }
        .badge-count { position: absolute; top: -2px; right: -2px; background: var(--danger); color: white; border-radius: 10px; border: 2px solid var(--bg-card); display: none; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 700; padding: 0 4px; min-width: 18px; height: 18px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .badge-count.active { display: flex; }

        .view-section { display: none; animation: fadeIn 0.4s ease; }
        .view-section.active-view { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--bg-card); border: 1px solid var(--border-color); padding: 18px; border-radius: 12px; position: relative; transition: transform 0.2s, box-shadow 0.3s, border-color 0.3s; box-shadow: var(--card-shadow); overflow: hidden; }
        .card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .card-val { font-size: 1.6rem; font-weight: 700; font-family: 'JetBrains Mono'; color: var(--text-main); margin: 8px 0; }
        .card-label { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .card-moto, .card-fiesta, .card-divida, .card-essential, .card-loan, .card-big-goal { border: 1px solid var(--border-color); }

        .progress-container { width: 100%; background: rgba(125,125,125,0.1); height: 8px; border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .progress-bar { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        .rule-bar { display: flex; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 15px; background: rgba(255,255,255,0.05); }
        .rule-segment { height: 100%; transition: width 0.5s ease; }
        .rule-legend { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.75rem; color: var(--text-muted); }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; }

        .cat-bar-container { margin-bottom: 8px; }
        .cat-bar-header { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; }
        .cat-bar-fill { height: 6px; border-radius: 3px; background: var(--primary); opacity: 0.7; }
        
        .chart-section { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 30px; box-shadow: var(--card-shadow); }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .mini-status { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; background: rgba(255,255,255,0.03); padding: 4px 10px; border-radius: 6px; border: 1px solid var(--border-color); }
        .status-dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; box-shadow: 0 0 5px var(--success); }
        .total-year-widget { display: flex; align-items: center; background: rgba(47, 129, 247, 0.08); border: 1px solid rgba(47, 129, 247, 0.2); padding: 5px 15px; border-radius: 8px; margin-right: 10px; height: 36px; }
        .tyw-label { font-size: 0.7rem; color: var(--primary); text-transform: uppercase; margin-right: 8px; font-weight: 600; }
        .tyw-value { font-size: 0.95rem; color: var(--text-main); font-family: 'JetBrains Mono'; font-weight: 700; }
        
        .chart-container { height: 280px; width: 100%; overflow-x: auto; overflow-y: hidden; display: flex; align-items: flex-end; padding-bottom: 5px; }
        .chart-wrapper { display: flex; align-items: flex-end; gap: 12px; height: 100%; min-width: 100%; padding-right: 10px; }
        .chart-bar-group { flex: 1; min-width: 40px; max-width: 60px; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; cursor: pointer; position: relative; transition: 0.2s; }
        .chart-val-top { font-size: 0.65rem; color: var(--text-main); margin-bottom: 4px; opacity: 0; transform: translateY(5px); transition: 0.2s; font-family: 'JetBrains Mono'; }
        .chart-bar-group:hover .chart-val-top { opacity: 1; transform: translateY(0); }
        .chart-bar-group:hover .chart-bar { opacity: 1; box-shadow: 0 0 10px var(--success); }
        .chart-bar { width: 100%; background: var(--success); opacity: 0.7; border-radius: 3px 3px 0 0; min-height: 4px; transition: height 0.5s ease; }
        .chart-label { margin-top: 6px; font-size: 0.65rem; color: var(--text-muted); font-family: 'JetBrains Mono'; text-align: center; }

        .table-responsive { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 12px; background: var(--bg-card); box-shadow: var(--card-shadow); }
        .income-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .income-table th { text-align: left; color: var(--text-muted); padding: 10px 15px; font-size: 0.7rem; text-transform: uppercase; border-bottom: 1px solid var(--border-color); }
        .income-table td { padding: 10px 15px; border-bottom: 1px solid var(--border-color); font-size: 0.85rem; color: var(--text-main); }
        .badge-pago { background: rgba(35, 134, 54, 0.2); color: #238636; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; border: 1px solid rgba(35, 134, 54, 0.3); }

        .transaction-list { display: flex; flex-direction: column; gap: 8px; }
        .transaction-item { background: var(--bg-card); border: 1px solid var(--border-color); padding: 10px 14px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--card-shadow); }
        .t-icon { width: 32px; height: 32px; border-radius: 8px; background: rgba(125,125,125,0.1); display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; margin-right: 12px; }

        .notif-item { padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s; }
        .notif-item:hover { background: var(--nav-hover); }
        .notif-item:last-child { border-bottom: none; }

        .select-filter { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main); padding: 6px 10px; border-radius: 6px; cursor: pointer; outline: none; font-size: 0.85rem; height: 36px; }
        .input-dark { width: 100%; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-main); padding: 10px; border-radius: 8px; margin-top: 5px; font-size: 0.9rem; height: 40px; }
        .search-bar { width: 100%; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px 12px; color: var(--text-main); margin-bottom: 15px; font-size: 0.9rem; }

        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; font-size: 0.85rem; height: 38px; white-space: nowrap; }
        .btn-success { background: var(--success); color: white; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: rgba(248, 81, 73, 0.1); color: #f85149; }
        .btn-warning { background: rgba(227, 179, 65, 0.2); color: #e3b341; border: 1px solid rgba(227, 179, 65, 0.4); }
        .btn-info { background: rgba(163, 113, 247, 0.1); color: var(--info); border: 1px solid rgba(163, 113, 247, 0.3); }
        .btn:active { transform: scale(0.96); }

        .mobile-toggle { display: none; position: fixed; top: 15px; left: 15px; z-index: 110; background: var(--bg-card); border: 1px solid var(--border-color); padding: 8px; border-radius: 8px; color: var(--text-main); box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 90; display: none; backdrop-filter: blur(4px); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); padding: 20px; transition: opacity 0.3s ease; }
        .modal-overlay.open { display: flex; animation: fadeIn 0.3s; }
        .modal { background: var(--modal-bg); width: 100%; max-width: 500px; border-radius: 16px; border: 1px solid var(--border-color); display: flex; flex-direction: column; max-height: 90vh; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); overflow: hidden; }
        @keyframes modalPop { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .modal-header { padding: 18px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.02); }
        .modal-header h3 { font-size: 1.1rem; font-weight: 700; }
        .modal-body { padding: 24px; overflow-y: auto; }

        .statement-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .statement-table th { text-align: left; padding: 12px; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid var(--border-color); background: rgba(0,0,0,0.02); }
        .statement-table td { padding: 12px; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; color: var(--text-main); }
        .statement-table tr:last-child td { border-bottom: none; }
        .statement-table tr:hover { background: var(--nav-hover); }

        .terminal-container { background: #0d1117; border: 1px solid #30363d; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; margin-top: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .terminal-window { height: 300px; overflow-y: auto; padding: 15px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: #E6EDF3; scroll-behavior: smooth; }

        .msg-sys { color: var(--info); margin-bottom: 5px; }
        .msg-success { color: var(--success); margin-bottom: 5px; }
        .msg-warn { color: var(--warning); margin-bottom: 5px; }
        .msg-err { color: var(--danger); margin-bottom: 5px; }
        .msg-user { color: var(--text-muted); text-align: right; margin-bottom: 8px; font-style: italic; border-right: 2px solid var(--primary); padding-right: 10px; }
        .chat-tag { display: inline-block; background: rgba(47, 129, 247, 0.15); color: var(--primary); padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; margin-right: 5px; border: 1px solid rgba(47, 129, 247, 0.3); transition: 0.2s; }
        .chat-tag:hover { background: var(--primary); color: white; }

        .cmd-input-area { display: flex; align-items: center; background: #161b22; padding: 10px; border-top: 1px solid #30363d; }
        .cmd-prompt { color: var(--success); margin-right: 10px; font-weight: bold; font-family: 'JetBrains Mono'; }
        .cmd-input { flex: 1; background: transparent; border: none; color: var(--text-main); font-family: 'JetBrains Mono'; outline: none; font-size: 0.9rem; }

        #tutorialBubble {
            position: fixed; bottom: 30px; right: 30px; width: 340px;
            background: var(--bg-card); border: 1px solid var(--primary);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); border-radius: 16px;
            z-index: 9999; padding: 20px; display: none;
            flex-direction: column; animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .tutorial-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .tutorial-header h2 { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .close-tutorial { background: transparent; border: none; color: var(--text-muted); cursor: pointer; }
        
        .step-dots { display: flex; justify-content: center; gap: 5px; margin: 15px 0; }
        .step-dot { width: 8px; height: 8px; background: var(--border-color); border-radius: 50%; transition: 0.3s; }
        .step-dot.active { background: var(--primary); transform: scale(1.2); }

        @media (max-width: 1100px) {
            aside { transform: translateX(-100%); box-shadow: 5px 0 30px rgba(0,0,0,0.5); padding-top: 80px; }
            aside.open { transform: translateX(0); }
            main { margin-left: 0; padding: 70px 20px 40px 20px; }
            .mobile-toggle { display: block; z-index: 200; }
            header { flex-direction: row; align-items: center; justify-content: space-between; }
            .header-left { margin-left: 50px; }
            .header-left h1 { font-size: 1.3rem; }
            .bio-quote, .user-info-text { display: none; }
            .income-table th:nth-child(4), .income-table td:nth-child(4), .income-table th:nth-child(5), .income-table td:nth-child(5) { display: none; }
            .tyw-label { display: none; } 
            .statement-table th:nth-child(3), .statement-table td:nth-child(3) { display: none; }
            #tutorialBubble { bottom: 20px; right: 20px; left: 20px; width: auto; max-width: none; }
        }

        .invest-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .cofrinho-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 25px; display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; overflow: hidden; }
        .cofrinho-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;}
        .cofrinho-icon { width: 70px; height: 70px; background: rgba(255, 215, 0, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; color: var(--invest-gold); font-size: 2rem; }
        .cofrinho-val { font-size: 2rem; font-weight: 800; font-family: 'JetBrains Mono'; color: var(--invest-gold); margin: 5px 0; }
        .cofrinho-label { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px; }
        
        .pie-chart-container { position: relative; width: 220px; height: 220px; margin: 0 auto 20px auto; border-radius: 50%; background: conic-gradient(var(--chart-1) 0% 0%); transition: background 1s ease; }
        .pie-chart-hole { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 160px; height: 160px; background: var(--bg-card); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .pie-total-label { font-size: 0.75rem; color: var(--text-muted); }
        .pie-total-val { font-size: 1.1rem; font-weight: 700; color: var(--text-main); font-family: 'JetBrains Mono'; }
        
        .chart-legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; font-size: 0.8rem; color: var(--text-muted); margin-top: 10px; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }

        .yield-card { background: rgba(0, 230, 118, 0.05); border: 1px solid rgba(0, 230, 118, 0.2); border-radius: 12px; padding: 15px; margin-top: 20px; width: 100%; display: flex; align-items: center; gap: 15px; }
        .yield-icon { width: 40px; height: 40px; background: rgba(0, 230, 118, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--invest-profit); font-size: 1.2rem; }

        .range-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; outline: none; margin: 10px 0; cursor: pointer; }
        .range-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--primary); border-radius: 50%; cursor: pointer; border: 2px solid var(--bg-card); box-shadow: 0 0 10px var(--primary-glow); margin-top: -6px; }
        .range-slider::-moz-range-thumb { width: 18px; height: 18px; background: var(--primary); border: 2px solid var(--bg-card); border-radius: 50%; cursor: pointer; box-shadow: 0 0 10px var(--primary-glow); }

        .sim-row { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-muted); }
        .sim-val-text { font-weight: 700; color: var(--primary); font-family: 'JetBrains Mono'; }
        
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin-top: 15px; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); }
        .checkbox-wrapper input { width: 18px; height: 18px; accent-color: var(--primary); }
        .checkbox-wrapper label { font-size: 0.85rem; color: var(--text-main); cursor: pointer; }
        .invest-list-item { background: var(--bg-card); border: 1px solid var(--border-color); padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; transition: transform 0.2s; }
        .invest-list-item:hover { transform: translateX(5px); border-color: var(--primary); }
        .inv-icon { width: 40px; height: 40px; border-radius: 10px; background: rgba(47, 129, 247, 0.1); display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.2rem; margin-right: 15px; }
        .inv-info h4 { font-size: 0.95rem; font-weight: 600; margin-bottom: 2px; }
        .inv-info p { font-size: 0.75rem; color: var(--text-muted); }
        .inv-val { text-align: right; }
        .inv-val h4 { font-size: 1rem; font-weight: 700; color: var(--text-main); font-family: 'JetBrains Mono'; }

        .multi-reserve-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid var(--border-color); font-size: 0.85rem; }
        .multi-reserve-item:last-child { border-bottom: none; }
        .multi-reserve-name { font-weight: 600; color: var(--text-main); }
        .multi-reserve-obj { color: var(--text-muted); font-size: 0.75rem; }
        .multi-reserve-val { font-weight: 700; color: var(--invest-gold); }
        
        .asset-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        .asset-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--card-shadow);
            border-color: var(--primary);
        }
        .asset-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        .asset-icon-box {
            width: 45px; height: 45px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
        }
        .asset-pill {
            font-size: 0.65rem;
            text-transform: uppercase;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 20px;
            letter-spacing: 0.5px;
        }
        .asset-body h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 5px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .asset-val {
            font-size: 1.3rem;
            font-weight: 700;
            font-family: 'JetBrains Mono';
            color: var(--text-main);
        }
        .asset-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 5px;
        }
        .asset-delete-btn {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(248, 81, 73, 0.1);
            color: var(--danger);
            border: none;
            width: 30px; height: 30px;
            border-radius: 8px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .asset-card:hover .asset-delete-btn {
            opacity: 1;
        }

        .type-renda-fixa .asset-icon-box { background: rgba(47, 129, 247, 0.15); color: var(--chart-1); }
        .type-renda-fixa .asset-pill { background: rgba(47, 129, 247, 0.1); color: var(--chart-1); border: 1px solid rgba(47, 129, 247, 0.2); }
        
        .type-acoes .asset-icon-box { background: rgba(0, 230, 118, 0.15); color: var(--chart-2); }
        .type-acoes .asset-pill { background: rgba(0, 230, 118, 0.1); color: var(--chart-2); border: 1px solid rgba(0, 230, 118, 0.2); }
        
        .type-cripto .asset-icon-box { background: rgba(227, 179, 65, 0.15); color: var(--chart-3); }
        .type-cripto .asset-pill { background: rgba(227, 179, 65, 0.1); color: var(--chart-3); border: 1px solid rgba(227, 179, 65, 0.2); }

        .empty-state-invest {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            background: rgba(255,255,255,0.02);
            border: 1px dashed var(--border-color);
            border-radius: 16px;
            color: var(--text-muted);
        }
        
        .invest-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        body.tutorial-active aside,
        body.tutorial-active .mobile-toggle,
        body.tutorial-active .header-actions,
        body.tutorial-active .sidebar-overlay { 
            display: none !important; 
        }
        
        body.tutorial-active main {
            margin-left: 0 !important;
            padding-top: 20px !important;
            filter: none !important; 
            pointer-events: auto !important;
            opacity: 1 !important;
        }
        .card-goal-premium {
            background: linear-gradient(145deg, var(--bg-card) 0%, rgba(35, 134, 54, 0.03) 100%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 25px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3);
        }

        .goal-watermark {
            position: absolute;
            right: -20px;
            top: -20px;
            font-size: 8rem;
            color: var(--success);
            opacity: 0.03;
            pointer-events: none;
            transform: rotate(15deg);
        }

        .goal-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .goal-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--text-muted);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-edit-goal {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            width: 32px; height: 32px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-edit-goal:hover {
            background: var(--nav-hover);
            color: var(--primary);
            border-color: var(--primary);
        }

        .goal-main-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.4rem;
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: -1px;
            line-height: 1;
        }

        .goal-stats-row {
            display: flex; 
            justify-content: space-between; 
            margin-top: 5px; 
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .badge-vencida {
            background: rgba(248, 81, 73, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 700;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        #adLockOverlay {
            position: fixed; inset: 0; 
            background: radial-gradient(circle at 50% 0%, #1c2128 0%, #050505 85%);
            z-index: 99999;
            display: none; align-items: center; justify-content: center;
            padding: 20px;
        }

        .lock-glass-card {
            background: rgba(13, 17, 23, 0.7); 
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-top: 1px solid rgba(47, 129, 247, 0.3);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), 0 0 30px rgba(47, 129, 247, 0.1);
            border-radius: 24px;
            padding: 40px 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: floatUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes floatUp { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }

        .lock-icon { 
            font-size: 3.5rem; 
            margin-bottom: 20px; 
            background: rgba(47, 129, 247, 0.1);
            width: 80px; height: 80px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            color: var(--primary);
            box-shadow: 0 0 20px var(--primary-glow);
            border: 1px solid rgba(47, 129, 247, 0.2);
        }

        .lock-timer-bar { 
            width: 100%; height: 6px; 
            background: rgba(255,255,255,0.05); 
            border-radius: 10px; 
            overflow: hidden; 
            margin-top: 25px; 
            display:none; 
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .lock-timer-fill { 
            height: 100%; width: 0%; 
            background: linear-gradient(90deg, var(--primary), #60a5fa); 
            box-shadow: 0 0 10px var(--primary);
            transition: width 1s linear; 
        }

        .access-timer-badge {
            background: rgba(35, 134, 54, 0.15); color: var(--success);
            border: 1px solid rgba(35, 134, 54, 0.3); padding: 5px 12px; border-radius: 20px;
            font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 6px;
        }
        .rating-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }

        .stars {
            display: flex;
            gap: 12px;
            margin: 20px 0;
            flex-direction: row-reverse;
        }

        .stars input { display: none; }

        .stars label {
            font-size: 2.2rem;
            color: var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .stars label:hover,
        .stars label:hover ~ label,
        .stars input:checked ~ label {
            color: var(--invest-gold);
            transform: scale(1.15);
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        .feedback-input-area {
            width: 100%;
            display: none;
            animation: fadeIn 0.5s;
            margin-top: 15px;
        }

        .feedback-textarea {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            resize: vertical;
            min-height: 80px;
            font-size: 0.9rem;
            outline: none;
        }
        
        .feedback-textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--nav-active-bg);
        }
        .version-pill {
            position: fixed;
            bottom: 15px;
            left: 15px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--text-muted);
            cursor: pointer;
            z-index: 990;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .version-pill:hover {
            color: var(--primary);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        .timeline {
            position: relative;
            padding-left: 20px;
            border-left: 2px solid var(--border-color);
            margin-top: 10px;
        }

        .timeline-item {
            margin-bottom: 25px;
            position: relative;
        }

        .timeline-dot {
            position: absolute;
            left: -26px;
            top: 0;
            width: 12px;
            height: 12px;
            background: var(--bg-panel);
            border: 2px solid var(--text-muted);
            border-radius: 50%;
        }

        .timeline-item.latest .timeline-dot {
            border-color: var(--success);
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        .version-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .version-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: block;
        }

        .version-desc {
            font-size: 0.9rem;
            color: var(--text-muted);
            line-height: 1.5;
        }
        
        .version-desc ul {
            padding-left: 20px;
            margin-top: 5px;
        }
        
        .version-desc li {
            margin-bottom: 4px;
        }

        .badge-new {
            background: rgba(35, 134, 54, 0.2);
            color: var(--success);
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            border: 1px solid var(--success);
        }
    </style>
</head>
<body>
    
    <div id="adLockOverlay">
        <div class="lock-glass-card">
            <div class="lock-icon">
                <i class="bi bi-rocket-takeoff-fill"></i>
            </div>
            
            <h2 style="margin-bottom: 8px; font-weight: 800; letter-spacing: -0.5px;">Liberar acesso</h2>
            
            <p style="color: var(--text-muted); font-size: 0.9rem; line-height: 1.5; margin-bottom: 30px; max-width: 280px;">
                Mantenha seu controle em dia. Apoie o projeto e garanta <strong>12 horas de acesso ilimitado</strong> a todas as ferramentas.
            </p>
            
            <button id="btnWatchAd" class="btn btn-primary" style="width: 100%; padding: 14px; font-size: 1rem; border-radius: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(47, 129, 247, 0.3);" onclick="AdSystem.watchAd()">
                <i class="bi bi-play-circle-fill"></i> Assistir (30s)
            </button>
            
            <div class="lock-timer-bar" id="adProgressBar">
                <div class="lock-timer-fill" id="adProgressFill"></div>
            </div>
            
            <p id="adStatusText" style="margin-top: 15px; font-size: 0.8rem; color: var(--text-muted); display: none; font-family: 'JetBrains Mono';">
                <span class="ptr-spinning" style="display:inline-block; margin-right:5px;">⏳</span> Conectando...
            </p>
            
            <button class="btn" style="margin-top: 20px; background: transparent; color: var(--text-muted); border: none; font-size: 0.85rem; padding: 5px;" onclick="window.location.replace('redir.html')">
                Voltar depois
            </button>
        </div>
    </div>

    <div id="tutorialBubble">
        <div id="tutorialContent"></div>
    </div>

    <div id="ptr-loader"><div id="ptr-spinner"></div></div>

    <button class="mobile-toggle" onclick="toggleSidebar()"><i class="bi bi-list" style="font-size: 1.5rem;"></i></button>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <aside id="mainSidebar">
        <div class="brand">
            <span class="brand-text">CAPITALIS <span style="color: var(--primary); font-weight: 300;">SOLUTION</span></span>
        </div>
        <nav class="nav-menu">
            <div class="nav-item active" onclick="switchView('finance', this)"><i class="bi bi-cash-coin"></i>Gestão de gastos</div>
            <div class="nav-item" onclick="switchView('income', this)"><i class="bi bi-graph-up-arrow"></i>Minha renda</div>
            <div class="nav-item" onclick="switchView('invest', this)"><i class="bi bi-rocket-takeoff"></i>Investimentos</div>
            
            <div class="nav-item" onclick="switchView('assets', this)"><i class="bi bi-bank"></i>Patrimônio e dívidas</div>
            <div class="nav-item" onclick="switchView('strategy', this)"><i class="bi bi-clipboard-data"></i>Estratégia e metas</div>
            <div class="nav-item" onclick="switchView('tools', this)"><i class="bi bi-terminal"></i>Terminal de pagamentos</div>
            <div class="nav-item" onclick="switchView('logs', this)"><i class="bi bi-hdd-network"></i>Logs e sistema</div>
        </nav>
        <div onclick="logout()" class="btn-logout"><i class="bi bi-box-arrow-right"></i>Encerrar sistema</div>
    </aside>

    <main id="mainContent">
        <header>
            <div class="header-left">
                <h1>Controle geral de finanças</h1>
                <p class="bio-quote">"Registre saídas e renda, controle seus empréstimos e financiamentos. Tudo isso e muito mais!"</p>
            </div>
            <div class="header-right">
                <div id="freeTimerBadge" class="access-timer-badge">
                    <i class="bi bi-clock-history"></i> <span id="timeRemaining">--:--</span>
                </div>

                <div class="header-actions">
                    <button id="notificationToggle" class="icon-btn" title="Notificações" onclick="openNotifications()">
                        <i class="bi bi-bell"></i>
                        <div id="notifBadge" class="badge-count"></div>
                    </button>
                    <button id="privacyToggle" class="icon-btn" title="Modo Privacidade">
                        <i class="bi bi-eye-slash"></i>
                    </button>
                    <button id="themeToggle" class="icon-btn" title="Alternar Tema">
                        <svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="70 40 325 325" preserveAspectRatio="xMidYMid meet" style="width: 20px; height: 20px; fill: currentColor;">
                            <g transform="translate(0.000000,500.000000) scale(0.100000,-0.100000)">
                                <path d="M1507 3963 c-4 -3 -7 -261 -7 -573 l0 -566 173 -152 c94 -83 195 -172 222 -196 l50 -45 126 -1 127 0 58 68 c32 37 78 87 101 112 23 25 54 61 68 80 14 18 31 37 37 42 7 4 -86 8 -207 8 l-220 0 -75 70 c-41 39 -90 82 -107 96 l-33 26 0 369 0 369 335 2 335 3 -33 35 c-18 19 -52 60 -76 90 -25 30 -49 60 -55 65 -6 6 -28 31 -49 58 l-38 47 -363 0 c-199 0 -366 -3 -369 -7z"></path>
                                <path d="M2416 3903 c32 -38 61 -70 64 -73 6 -5 262 -300 304 -350 40 -49 141 -165 146 -170 3 -3 22 -25 42 -50 l37 -46 -92 -105 c-95 -110 -446 -520 -530 -621 l-49 -58 200 0 199 0 99 117 c54 65 122 142 149 173 130 146 410 480 410 489 0 10 -29 45 -179 220 -54 64 -110 130 -124 146 -14 17 -53 62 -86 100 -34 39 -74 86 -90 105 -16 19 -60 70 -98 113 l-70 77 -195 0 -195 0 58 -67z"></path>
                                <path d="M3300 3564 c0 -3 44 -60 98 -125 53 -66 117 -144 141 -174 l43 -54 -146 -170 c-80 -94 -146 -173 -146 -176 0 -3 33 -5 74 -5 l74 0 154 168 c84 92 157 170 162 173 4 4 7 11 5 17 -2 5 -74 87 -159 181 l-155 171 -72 0 c-40 0 -73 -3 -73 -6z"></path>
                            </g>
                        </svg>
                    </button>
                </div>
                <div class="user-badge">
                    <div class="user-info-text" style="text-align: right; margin-right: 10px;">
                        <div id="userNameDisplay" style="font-size: 0.95rem; font-weight: 700;">Usuário</div>
                    </div>
                    <div id="userAvatarLetter" class="avatar-circle">A</div>
                </div>
            </div>
        </header>

        <section id="view-finance" class="view-section active-view">
            <div class="stats-grid">
                <div class="card" onclick="openMonthlyReport()" style="cursor: pointer;">
                    <div class="card-label">Saídas (mês)</div>
                    <div class="card-val blur-sensitive" style="color: var(--danger)" id="finTotal">R$ 0,00</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px;">
                        <i class="bi bi-file-earmark-text"></i>Clique aqui para ver o extrato completo!
                    </div>
                </div>
                <div class="card" style="border: 1px dashed var(--border-color); display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="openAddTransaction()">
                    <div style="text-align: center; color: var(--text-muted); font-size: 0.85rem;"><i class="bi bi-plus-lg" style="margin-right: 5px;"></i>Adicione nova despesa</div>
                </div>
            </div>
            
            <div class="card" style="margin-bottom: 20px; padding: 15px;">
                <div style="font-size:0.85rem; margin-bottom:10px; color:var(--text-main); font-weight:600;">Ranking de categorias do mês</div>
                <div id="categorySummary"></div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>Últimas transações</h3>
                <input type="month" id="filterMonth" class="select-filter" onchange="renderFinance()">
            </div>
            <input type="text" id="financeSearch" class="search-bar" placeholder="Buscar (ex: gasolina, mercado)..." onkeyup="renderFinance()">
            <div class="transaction-list" id="transactionList"></div>
        </section>

        <section id="view-income" class="view-section">
            <div class="chart-section">
                <div class="chart-header">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <h3 style="margin: 0; font-size:1.1rem;">Evolução líquida</h3>
                        <div class="mini-status"><div class="status-dot"></div><span style="color: var(--text-muted);">Empresa parceira</span></div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div class="total-year-widget">
                            <span class="tyw-label">Total:</span>
                            <span class="tyw-value blur-sensitive" id="yearTotalDisplay">R$ 0,00</span>
                        </div>
                        <select id="incomeYearFilter" class="select-filter" onchange="renderIncome()" style="min-width: 80px;"></select>
                    </div>
                </div>
                <div class="chart-container"><div class="chart-wrapper" id="incomeChart"></div></div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>Histórico completo</h3>
                <button class="btn btn-success" onclick="openAddIncome()">Adicionar nova renda</button>
            </div>
            <div class="table-responsive">
                <table class="income-table">
                    <thead><tr><th>Data</th><th>Empresa</th><th>Cargo</th><th>Tipo</th><th>Bruto</th><th>Líquido</th><th>Status</th><th></th></tr></thead>
                    <tbody id="incomeTableBody"></tbody>
                </table>
            </div>
        </section>

        <section id="view-invest" class="view-section">
            <div class="invest-grid">
                <div class="cofrinho-card">
                    <div class="cofrinho-icon"><i class="bi bi-piggy-bank-fill"></i></div>
                    <div class="cofrinho-label">Minha reserva (Instituição)</div>
                    <div class="cofrinho-val blur-sensitive" id="reserveVal">R$ 0,00</div>
                    <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:15px;" id="reserveLoc">Não definido</div>
                    <button class="btn btn-warning" style="width:100%; color:black;" onclick="Invest.openReserveModal()">Adicionar nova reserva</button>
                </div>

                <div class="card" style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
                    <div class="card-label" style="width:100%; text-align:left; margin-bottom:20px;">Distribuição da Carteira</div>
                    <div class="pie-chart-container" id="pieChart">
                        <div class="pie-chart-hole">
                            <div class="pie-total-label">Total Investido</div>
                            <div class="pie-total-val blur-sensitive" id="totalInvestChart">R$ 0,00</div>
                        </div>
                    </div>
                    <div class="chart-legend" id="pieLegend"></div>
                    <div class="yield-card">
                        <div class="yield-icon"><i class="bi bi-graph-up-arrow"></i></div>
                        <div>
                            <div style="font-size:0.75rem; color:var(--text-muted);">Est. rendimento mensal (0.8%)</div>
                            <div style="font-weight:700; color:var(--invest-profit);" class="blur-sensitive" id="yieldEst">+ R$ 0,00</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-label" style="margin-bottom:15px;"><i class="bi bi-calculator"></i> Simulador de Futuro (10% a.a)</div>
                    <div class="sim-row"><span>Aporte mensal</span><span class="sim-val-text" id="simM_disp">R$ 500</span></div>
                    <input type="range" class="range-slider" min="100" max="5000" step="50" value="500" id="simM" oninput="Invest.updateSim()">
                    
                    <div class="sim-row"><span>Tempo (Anos)</span><span class="sim-val-text" id="simY_disp">10 Anos</span></div>
                    <input type="range" class="range-slider" min="1" max="40" step="1" value="10" id="simY" oninput="Invest.updateSim()">

                    <div style="margin-top:20px; text-align:center; padding:15px; background:rgba(47,129,247,0.1); border-radius:10px;">
                        <div style="font-size:0.8rem; color:var(--text-muted);">Total acumulado</div>
                        <div class="card-val blur-sensitive" style="color:var(--primary); margin:5px 0;" id="simResult">R$ 0,00</div>
                        <div style="font-size:0.75rem; color:var(--text-muted);">Juros: <span style="color:var(--invest-profit)" id="simInterest">R$ 0,00</span></div>
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>Gerenciador de ativos</h3>
                <button class="btn btn-primary" onclick="Invest.openAddModal()"><i class="bi bi-plus"></i>Adicionar novo aporte</button>
            </div>
            
            <div class="invest-list-grid" id="investList"></div>
        </section>

        <section id="view-assets" class="view-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">Gerenciamento de ativos de longo prazo</h3>
                <button class="btn btn-primary" onclick="openAddAsset()"><i class="bi bi-plus"></i>Adicionar novo ativo</button>
            </div>
            <div class="stats-grid" id="assetsContainer"></div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 30px 0 15px 0;">
                <h3>Planejamentos e metas</h3>
                <button class="btn btn-info" onclick="openAddBigGoal()"><i class="bi bi-plus"></i>Adicionar nova meta</button>
            </div>
            <div class="stats-grid" id="bigGoalsContainer"></div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 30px 0 15px 0;">
                <h3>Monitor de empréstimos</h3>
                <button class="btn btn-warning" onclick="openAddLoan()"><i class="bi bi-plus"></i>Adicionar novo empréstimo</button>
            </div>
            <div class="stats-grid" id="loanCardsContainer"></div>
        </section>

        <section id="view-strategy" class="view-section">
            <div class="header-box" style="margin-bottom: 20px;">
                <h3>Registro de metas e análise de distribuição</h3>
            </div>

            <div class="card-goal-premium">
                <i class="bi bi-bullseye goal-watermark"></i>

                <div class="goal-header-row">
                    <div class="goal-title">
                        <span style="width: 8px; height: 8px; background: var(--success); border-radius: 50%; box-shadow: 0 0 8px var(--success);"></span>
                        Meta de sobra (Caixa)
                    </div>
                    <button class="btn-edit-goal" onclick="Strategy.setGoal()" title="Alterar Meta">
                        <i class="bi bi-pencil-fill" style="font-size: 0.8rem;"></i>
                    </button>
                </div>

                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <div style="font-size: 0.85rem; color: var(--text-muted);" id="goalBtnText">Definir objetivo</div>
                    <div id="goalTarget" class="goal-main-value blur-sensitive">R$ 0,00</div>
                </div>

                <div class="progress-container" style="height: 10px; background: rgba(255,255,255,0.05); margin: 20px 0 10px 0;">
                    <div id="goalBar" class="progress-bar" style="width: 0%; background: linear-gradient(90deg, var(--success), #4ade80);"></div>
                </div>

                <div class="goal-stats-row">
                    <span>Atual: <strong id="goalCurrent" class="blur-sensitive" style="color: var(--text-main);">R$ 0,00</strong></span>
                    <span id="goalMessage" style="font-style: italic;">Defina um valor</span>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
                <div>
                    <h4 style="margin-bottom: 15px; font-size: 0.95rem; color: var(--text-muted); display: flex; align-items: center; gap: 8px;">
                        Contas essenciais
                    </h4>
                    <div id="essentialList" class="transaction-list"></div>
                </div>
                <div>
                    <h4 style="margin-bottom: 15px; font-size: 0.95rem; color: var(--text-muted); display: flex; align-items: center; gap: 8px;">
                        Outras obrigações
                    </h4>
                    <div id="loanList" class="transaction-list"></div>
                </div>
            </div>
            
            <div class="card card-strategy" style="margin-top: 30px;">
                <div class="card-label">Análise de Distribuição (50/30/20)</div>
                <div style="margin-top: 20px;">
                    <div class="rule-legend"><span class="legend-item"><div class="legend-dot" style="background:var(--success)"></div>Essencial (50%)</span><span id="pctEssencial">0%</span></div>
                    <div class="rule-bar"><div class="rule-segment" id="barEssencial" style="background:var(--success); width:0%"></div></div>
                    
                    <div class="rule-legend"><span class="legend-item"><div class="legend-dot" style="background:var(--warning)"></div>Estilo de vida (30%)</span><span id="pctEstilo">0%</span></div>
                    <div class="rule-bar"><div class="rule-segment" id="barEstilo" style="background:var(--warning); width:0%"></div></div>
                    
                    <div class="rule-legend"><span class="legend-item"><div class="legend-dot" style="background:var(--danger)"></div>Dívidas (20%)</span><span id="pctDividas">0%</span></div>
                    <div class="rule-bar"><div class="rule-segment" id="barDividas" style="background:var(--danger); width:0%"></div></div>
                </div>
            </div>
        </section>

        <section id="view-tools" class="view-section">
            <div class="card" style="padding: 0; overflow: hidden; display: flex; flex-direction: column; height: 500px;">
                <div id="assistTerminal" class="terminal-window" style="flex: 1; background: #0d1117; padding: 20px; overflow-y: auto;">
                    </div>
                <div class="cmd-input-area" style="background: #161b22; padding: 15px; border-top: 1px solid #30363d;">
                    <span class="cmd-prompt">>></span>
                    <input type="text" id="cmdInput" class="cmd-input" placeholder="Inicie seus investimentos, faça pagamentos, tudo isso por aqui!.." autocomplete="off">
                </div>
            </div>
        </section>

        <section id="view-logs" class="view-section">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; flex-wrap: wrap; gap:10px;">
                <h3>Restauração e logs</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="System.backup()"><i class="bi bi-download"></i>Backup JSON</button>
                    <input type="file" id="restoreFile" style="display:none;" onchange="System.restore(this)">
                    <button class="btn btn-warning" onclick="document.getElementById('restoreFile').click()"><i class="bi bi-upload"></i>Restaurar</button>
                </div>
            </div>
            <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                 <button class="btn btn-primary" onclick="Logger.export()"><i class="bi bi-file-text"></i>Exportar logs</button>
                 <button class="btn btn-danger" onclick="Logger.clear()">Limpar logs</button>
                 <button class="btn btn-danger" style="background-color: #8b0000; border: 1px solid #ff4444;" onclick="System.openReset()"><i class="bi bi-exclamation-triangle-fill"></i>RESET GERAL</button>
            </div>
            <div id="logsTerminal" style="font-family: 'JetBrains Mono'; font-size: 0.8rem; display: flex; flex-direction: column; gap: 8px; max-height: 60vh; overflow-y: auto; padding-right: 5px;"></div>
        </section>
    </main>

    <div class="modal-overlay" id="transactionModal">
        <div class="modal">
            <div class="modal-header"><h3>Nova despesa</h3><button class="btn" style="background:transparent; color:var(--text-main); padding:0; width:30px;" onclick="closeModal('transactionModal')"><i class="bi bi-x-lg"></i></button></div>
            <div class="modal-body">
                <label style="color:var(--text-muted); font-size:0.8rem;">Descrição</label><input type="text" id="tDesc" class="input-dark" placeholder="Ex: Mercado semanal">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div><label style="color:var(--text-muted); font-size:0.8rem;">Valor (R$)</label><input type="text" inputmode="decimal" id="tAmount" class="input-dark" placeholder="0,00"></div>
                    <div><label style="color:var(--text-muted); font-size:0.8rem;">Categoria</label><select id="tCat" class="input-dark"><option value="Aluguel">Aluguel</option><option value="Luz">Luz</option><option value="Agua">Água</option><option value="Internet">Internet</option><option value="Vivo">Celular</option><option value="Mercado">Mercado</option><option value="Fralda">Fralda</option><option value="Gasolina">Gasolina</option><option value="Banco">Banco</option><option value="Compras na Internet">Web</option><option value="Gastos por Fora">Outros</option></select></div>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 25px;" onclick="saveTransaction()">Salvar transação</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="investAddModal">
        <div class="modal">
            <div class="modal-header"><h3>Adicionar novo aporte</h3><button class="btn" style="background:transparent; color:var(--text-main); padding:0; width:30px;" onclick="closeModal('investAddModal')"><i class="bi bi-x-lg"></i></button></div>
            <div class="modal-body">
                <label style="color:var(--text-muted); font-size:0.8rem;">Nome do ativo</label><input type="text" id="invName" class="input-dark" placeholder="Ex: CDB Nubank, Tesouro Selic">
                <div style="margin-top:15px;">
                    <label style="color:var(--text-muted); font-size:0.8rem;">Tipo</label>
                    <select id="invType" class="input-dark">
                        <option value="Renda Fixa">Renda fixa (CDB, Tesouro)</option>
                        <option value="Ações">Ações / FIIs</option>
                        <option value="Cripto">Criptomoedas</option>
                        <option value="Reserva">Reserva de emergência</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div style="margin-top:15px;">
                    <label style="color:var(--text-muted); font-size:0.8rem;">Valor aportado (R$)</label>
                    <input type="text" inputmode="decimal" id="invAmount" class="input-dark" placeholder="0,00">
                </div>
                
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="debitFromFinance">
                    <label for="debitFromFinance">Deseja debitar esse valor do saldo?</label>
                </div>

                <button class="btn btn-success" style="width: 100%; margin-top: 25px;" onclick="Invest.add()">Salvar na carteira</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="reserveModal">
        <div class="modal">
            <div class="modal-header"><h3>Meu cofrinho</h3><button class="btn" style="background:transparent; color:var(--text-main); padding:0; width:30px;" onclick="closeModal('reserveModal')"><i class="bi bi-x-lg"></i></button></div>
            <div class="modal-body">
                <div class="checkbox-wrapper" style="margin-bottom: 20px;">
                    <input type="checkbox" id="hasMultipleReserves" onchange="Invest.toggleMultipleReserves()">
                    <label for="hasMultipleReserves">Marque essa opção se você desejar adicionar mais de uma reserva</label>
                </div>

                <div id="singleReserveContainer">
                    <label style="color:var(--text-muted); font-size:0.8rem;">Em qual instituição sua reserva está guardada?</label>
                    <input type="text" id="resInstitution" class="input-dark" placeholder="Ex: Caixinha Nubank">
                    <div style="margin-top:15px;">
                        <label style="color:var(--text-muted); font-size:0.8rem;">Qual valor você está guardando na instituição?</label>
                        <input type="text" inputmode="decimal" id="resValue" class="input-dark" placeholder="0,00">
                    </div>
                </div>

                <div id="multiReserveContainer" style="display:none;">
                    <div id="multiReserveList" style="margin-bottom:15px; max-height: 150px; overflow-y: auto;">
                        </div>
                    <div style="border: 1px dashed var(--border-color); padding: 15px; border-radius: 12px; background: rgba(255,255,255,0.02);">
                        <label style="color:var(--text-muted); font-size:0.75rem;">Adicionar novo local:</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px;">
                            <input id="multiResInst" class="input-dark" placeholder="Local" style="margin:0;">
                            <input id="multiResVal" class="input-dark" placeholder="Valor" inputmode="decimal" style="margin:0;">
                        </div>
                        <input id="multiResObj" class="input-dark" placeholder="Objetivo (Opcional)" style="margin-top:10px;">
                        <button class="btn btn-primary" style="width:100%; margin-top:10px; font-size: 0.8rem;" onclick="Invest.addMultiItem()">+ Adicionar Item</button>
                    </div>
                </div>

                <button class="btn btn-warning" style="width: 100%; margin-top: 25px; color: black;" onclick="Invest.saveReserve()">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="debtModal">
        <div class="modal">
            <div class="modal-header"><h3>Nova conta / dívida</h3><button class="btn" style="background:transparent; color:var(--text-main); padding:0; width:30px;" onclick="closeModal('debtModal')"><i class="bi bi-x-lg"></i></button></div>
            <div class="modal-body">
                <label style="color:var(--text-muted); font-size:0.8rem;">Tipo de conta</label>
                <select id="dType" class="input-dark" style="margin-bottom:15px;" onchange="toggleDebtFields()">
                    <option value="essential">Conta essencial (Aluguel, Luz...)</option>
                    <option value="loan">Empréstimo / Consignado</option>
                </select>
                <label style="color:var(--text-muted); font-size:0.8rem;">Nome da conta (ID)</label>
                <input type="text" id="dName" class="input-dark" placeholder="Ex: Luz, Internet, Banco X">
                <div style="font-size:0.7rem; color:var(--warning); margin-bottom:10px;">*Este nome será usado como ID no terminal.</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                    <div><label style="color:var(--text-muted); font-size:0.8rem;">Saldo devedor</label><input type="text" inputmode="decimal" id="dAmount" class="input-dark" placeholder="0,00"></div>
                    <div><label style="color:var(--text-muted); font-size:0.8rem;">Vencimento</label><input type="number" id="dDue" class="input-dark" placeholder="Dia (1-31)"></div>
                </div>
                <div id="loanFields" style="display:none; margin-top:15px; border-top:1px solid var(--border-color); padding-top:15px;">
                    <label style="color:var(--info); font-size:0.8rem; font-weight:700;">Valor da parcela (mensal)</label>
                    <input type="text" inputmode="decimal" id="dInstValue" class="input-dark" placeholder="0,00" style="margin-bottom:15px; border-color:var(--info);">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div><label style="color:var(--text-muted); font-size:0.8rem;">Parcela atual</label><input type="number" id="dCurrInst" class="input-dark" value="1"></div>
                        <div><label style="color:var(--text-muted); font-size:0.8rem;">Total parcelas</label><input type="number" id="dTotalInst" class="input-dark" value="12"></div>
                    </div>
                </div>
                <button class="btn btn-warning" style="width: 100%; margin-top: 25px;" onclick="saveDebt()">Cadastrar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="assetAddModal">
        <div class="modal">
            <div class="modal-header"><h3>Novo ativo fixo</h3><button class="btn" style="background:transparent; color:var(--text-main); padding:0; width:30px;" onclick="closeModal('assetAddModal')"><i class="bi bi-x-lg"></i></button></div>
            <div class="modal-body">
                <label style="color:var(--text-muted); font-size:0.8rem;">Nome do ativo</label><input type="text" id="assetName" class="input-dark" placeholder="Ex: Moto, Carro">
                <label style="color:var(--text-muted); font-size:0.8rem; margin-top:10px; display:block;">Tipo</label>
                <select id="assetType" class="input-dark" onchange="toggleAssetColor()"><option value="payable">Pagamento em andamento</option><option value="receivable">Recebimento em andamento</option></select>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div><label style="color:var(--text-muted); font-size:0.8rem;">Parcela atual</label><input type="number" id="assetCurrent" class="input-dark" value="0"></div>
                    <div><label style="color:var(--text-muted); font-size:0.8rem;">Total parcelas</label><input type="number" id="assetTotal" class="input-dark" placeholder="60"></div>
                </div>
                <div style="margin-top:10px;">
                    <label style="color:var(--text-muted); font-size:0.8rem;">Valor da parcela (R$)</label><input type="text" inputmode="decimal" id="assetValue" class="input-dark" placeholder="0,00">
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 25px;" onclick="Assets.add()">Criar ativo</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="assetManageModal">
        <div class="modal">
            <div class="modal-header"><h3 id="assetManageTitle">Clique aqui para gerenciar!</h3><button class="btn" style="background:transparent; color:var(--text-main); padding:0; width:30px;" onclick="closeModal('assetManageModal')"><i class="bi bi-x-lg"></i></button></div>
            <div class="modal-body">
                <p style="color:var(--text-muted); margin-bottom:20px; text-align:center;">Selecione a ação para este ativo.</p>
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <button id="btnAssetPay" class="btn btn-primary" style="height:50px;">Realizar pagamento / recebimento</button>
                    <button id="btnAssetUndo" class="btn btn-danger" style="height:50px; background:rgba(248,81,73,0.15); border:1px solid var(--danger);">Corrigir parcela anterior</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="bigGoalModal">
        <div class="modal">
            <div class="modal-header"><h3>Nova meta de longo prazo</h3><button class="btn" style="background:transparent; color:var(--text-main); padding:0; width:30px;" onclick="closeModal('bigGoalModal')"><i class="bi bi-x-lg"></i></button></div>
            <div class="modal-body">
                <label style="color:var(--text-muted); font-size:0.8rem;">Nome da meta</label><input type="text" id="bgName" class="input-dark" placeholder="Ex: Viagem Europa">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div><label style="color:var(--text-muted); font-size:0.8rem;">Valor total (R$)</label><input type="text" inputmode="decimal" id="bgTotal" class="input-dark" placeholder="0,00"></div>
                    <div><label style="color:var(--text-muted); font-size:0.8rem;">Já guardado (R$)</label><input type="text" inputmode="decimal" id="bgCurrent" class="input-dark" placeholder="0,00"></div>
                </div>
                <button class="btn btn-info" style="width: 100%; margin-top: 25px;" onclick="saveBigGoal()">Criar meta</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="notifModal">
        <div class="modal">
            <div class="modal-header"><h3>Alertas de vencimento</h3><button class="btn" style="background:transparent; color:var(--text-main); padding:0; width:30px;" onclick="closeModal('notifModal')"><i class="bi bi-x-lg"></i></button></div>
            <div class="modal-body" id="notifContent">
                <div style="text-align:center; color:var(--text-muted);">Nenhuma conta próxima do vencimento.</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="actionModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header"><h3 id="actionTitle">Ação</h3><button class="btn" style="background:transparent; color:var(--text-main); padding:0; width:30px;" onclick="closeModal('actionModal')"><i class="bi bi-x-lg"></i></button></div>
            <div class="modal-body">
                <div style="text-align:center; margin-bottom:20px; color:var(--text-muted);">O que deseja fazer com esta conta?</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <button class="btn btn-info" onclick="Debts.markAsRead()">Marcar como lida</button>
                    <button class="btn btn-danger" onclick="Debts.deleteFromAction()">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="incomeModal">
        <div class="modal">
            <div class="modal-header"><h3>Nova renda</h3><button class="btn" style="background:transparent; color:var(--text-main); padding:0; width:30px;" onclick="closeModal('incomeModal')"><i class="bi bi-x-lg"></i></button></div>
            <div class="modal-body">
                <div style="margin-bottom:10px;"><label style="color:var(--text-muted); font-size:0.8rem;">Data</label><input type="date" id="incDate" class="input-dark"></div>
                <div style="margin-bottom:10px;"><label style="color:var(--text-muted); font-size:0.8rem;">Empresa</label><input type="text" id="incCompany" class="input-dark" value="Empresa Exemplo"></div>
                <div style="margin-bottom:10px;"><label style="color:var(--text-muted); font-size:0.8rem;">Cargo</label><input type="text" id="incRole" class="input-dark" value="Analista"></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div><label style="color:var(--text-muted); font-size:0.8rem;">Bruto (R$)</label><input type="text" inputmode="decimal" id="incGross" class="input-dark" placeholder="0,00"></div>
                    <div><label style="color:var(--text-muted); font-size:0.8rem;">Líquido (R$)</label><input type="text" inputmode="decimal" id="incNet" class="input-dark" placeholder="0,00"></div>
                </div>
                <div style="margin-top:10px;"><label style="color:var(--text-muted); font-size:0.8rem;">Status inicial</label><select id="incStatus" class="input-dark"><option value="Pago">Pago</option><option value="Pendente" selected>Pendente (A Receber)</option></select></div>
                <button class="btn btn-success" style="width: 100%; margin-top: 25px;" onclick="Income.save()">Registrar renda</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="reportModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header"><h3>Extrato detalhado</h3><button class="btn" style="background:transparent; color:var(--text-main); padding:0; width:30px;" onclick="closeModal('reportModal')"><i class="bi bi-x-lg"></i></button></div>
            <div class="modal-body" style="padding: 0;">
                <div id="reportSummary" style="padding: 20px; background: var(--bg-panel); display: flex; justify-content: space-around; text-align: center; border-bottom: 1px solid var(--border-color);"></div>
                <div style="padding: 0; max-height: 60vh; overflow-y: auto;">
                    <table class="statement-table">
                        <thead><tr><th>Data</th><th>Tipo</th><th>Categoria</th><th>Descrição</th><th>Valor</th><th>Ação</th></tr></thead>
                        <tbody id="reportTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="resetModal">
        <div class="modal" style="max-width: 400px; border-color: var(--danger);">
            <div class="modal-header" style="background: rgba(248, 81, 73, 0.1);"><h3 style="color: var(--danger);">⚠️ ATENÇÃO - RESET GERAL</h3></div>
            <div class="modal-body">
                <p style="text-align: center; margin-bottom: 20px;">Você tem certeza que deseja <strong>APAGAR TODOS OS DADOS</strong>?<br><br>Esta ação não pode ser desfeita. Faça um backup antes.</p>
                <button id="btnConfirmReset" class="btn btn-danger" style="width: 100%; height: 50px; font-weight: bold; margin-bottom: 10px;" onclick="System.confirmReset()" disabled>Aguarde...</button>
                <button class="btn" style="width: 100%; border: 1px solid var(--border-color);" onclick="closeModal('resetModal')">NÃO, CANCELAR</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="termsModal" style="z-index: 10000;">
        <div class="modal" style="max-width: 600px; height: 85vh;">
            <div class="modal-header">
                <h3><i class="bi bi-file-text"></i> Termos de Uso e Privacidade</h3>
                </div>
            <div class="modal-body" style="padding: 0; display: flex; flex-direction: column; height: 100%;">
                
                <div style="flex: 1; overflow-y: auto; padding: 25px; line-height: 1.6; color: var(--text-main);">
                    
                    <div style="background: rgba(47, 129, 247, 0.1); border: 1px solid var(--primary); border-radius: 12px; padding: 15px; margin-bottom: 25px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">Resumo simples (para todas as idades)</h4>
                        <p style="font-size: 0.9rem; margin-bottom: 0;">
                            Imagine que o <strong>Capitalis</strong> é um caderno de anotações dentro do seu bolso. 
                            Tudo o que você registra, ou adiciona aqui <strong>fica apenas no seu celular</strong>. 
                            Nós (os criadores) não conseguimos ver, ler, nem vender seus dados, porque eles nunca saem do seu aparelho.
                            <br><br>
                            <strong>Importante:</strong> Como só fica no seu celular, se você perder o aparelho ou apagar o aplicativo sem fazer um "Backup" (cópia de segurança), você perde suas anotações. Cuide bem dos seus dados!
                        </p>
                    </div>

                    <h4 style="margin-bottom: 15px;">TERMOS DE USO E POLÍTICA DE PRIVACIDADE</h4>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 20px;">
                        <strong>Aplicativo:</strong> Capitalis Solution<br>
                        <strong>Desenvolvedores:</strong> Algarte e Daniel<br>
                        <strong>Versão dos Termos:</strong> Janeiro/2026
                    </p>

                    <h5 style="color: var(--text-main); margin-top: 20px;">1. PRIVACIDADE E DADOS (OFFLINE-FIRST)</h5>
                    <p style="font-size: 0.9rem; color: var(--text-muted);">
                        O Capitalis opera sob a política "Offline-First". Isso significa que não possuímos servidores de banco de dados para armazenar informações dos usuários. Todos os registros financeiros, metas e configurações são salvos exclusivamente na memória local (Storage) do dispositivo do usuário. A empresa não tem acesso, em hipótese alguma, aos dados inseridos.
                    </p>

                    <h5 style="color: var(--text-main); margin-top: 20px;">2. RESPONSABILIDADE DO USUÁRIO (BACKUPS)</h5>
                    <p style="font-size: 0.9rem; color: var(--text-muted);">
                        É de inteira responsabilidade do USUÁRIO a preservação de seus dados. O aplicativo oferece a ferramenta de "Backup JSON" na aba de Logs. O USUÁRIO deve realizar exportações periódicas. Os desenvolvedores não se responsabilizam por perdas de dados decorrentes de: perda/roubo do aparelho, limpeza de cache do navegador/sistema, desinstalação do app ou formatação do dispositivo.
                    </p>

                    <h5 style="color: var(--text-main); margin-top: 20px;">3. ISENÇÃO DE RESPONSABILIDADE FINANCEIRA</h5>
                    <p style="font-size: 0.9rem; color: var(--text-muted);">
                        O Capitalis é uma ferramenta de organização e simulação. Os cálculos de investimentos e juros são estimativas baseadas em dados inseridos pelo usuário e índices de mercado padrão (ex: 0.8% a.m ou 10% a.a). Não garantimos rentabilidade real e não nos responsabilizamos por decisões financeiras tomadas com base no aplicativo.
                    </p>

                    <h5 style="color: var(--text-main); margin-top: 20px;">4. MODELO DE ACESSO</h5>
                    <p style="font-size: 0.9rem; color: var(--text-muted);">
                        O aplicativo é disponibilizado gratuitamente através de um sistema patrocinado. Para manter a infraestrutura e desenvolvimento, o usuário concorda em assistir a breves anúncios publicitários em troca de períodos de acesso liberado (ex: 12 horas).
                    </p>

                    <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 30px 0;">
                    <p style="font-size: 0.8rem; text-align: center; color: var(--text-muted);">
                        Ao clicar em "Li e Concordo", você declara estar ciente de que seus dados são de sua exclusiva responsabilidade.
                    </p>
                </div>

                <div style="padding: 20px; border-top: 1px solid var(--border-color); background: var(--bg-card);">
                    <button class="btn btn-success" style="width: 100%; padding: 15px; font-size: 1rem;" onclick="Tutorial.acceptTerms()">
                        <i class="bi bi-shield-check-fill"></i> LI E CONCORDO COM OS TERMOS
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal-overlay" id="feedbackModal" style="z-index: 11000;">
        <div class="modal" style="max-width: 420px; border-top: 3px solid var(--invest-gold);">
            <div class="modal-header">
                <h3><i class="bi bi-stars" style="color: var(--invest-gold);"></i> Sua opinião importa</h3>
                <button class="btn" style="background:transparent; color:var(--text-main); padding:0; width:30px;" onclick="Feedback.later()"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="modal-body">
                <p style="text-align: center; color: var(--text-main); font-size: 0.95rem; line-height: 1.6; margin-bottom: 20px;">
                    A <strong>Capitalis Solution</strong> agradece imensamente por você utilizar nosso aplicativo!<br><br>
                    Estamos sempre buscando evoluir. Você poderia nos dizer se há algo que possamos melhorar ou o que está achando da experiência?
                </p>

                <div class="rating-box">
                    <div class="stars">
                        <input type="radio" id="star5" name="rating" value="5" onclick="Feedback.showInput()"><label for="star5"><i class="bi bi-star-fill"></i></label>
                        <input type="radio" id="star4" name="rating" value="4" onclick="Feedback.showInput()"><label for="star4"><i class="bi bi-star-fill"></i></label>
                        <input type="radio" id="star3" name="rating" value="3" onclick="Feedback.showInput()"><label for="star3"><i class="bi bi-star-fill"></i></label>
                        <input type="radio" id="star2" name="rating" value="2" onclick="Feedback.showInput()"><label for="star2"><i class="bi bi-star-fill"></i></label>
                        <input type="radio" id="star1" name="rating" value="1" onclick="Feedback.showInput()"><label for="star1"><i class="bi bi-star-fill"></i></label>
                    </div>

                    <div id="feedbackComment" class="feedback-input-area">
                        <textarea id="feedbackText" class="feedback-textarea" rows="3" placeholder="Escreva sua sugestão, elogio ou crítica aqui..."></textarea>
                        <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="Feedback.send()">Enviar Feedback</button>
                    </div>
                </div>

                <button class="btn" style="width: 100%; background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); margin-top: 15px;" onclick="Feedback.later()">Lembrar mais tarde</button>
            </div>
        </div>
    </div>
    <div class="version-pill" onclick="Updates.openHistory()">
        <i class="bi bi-info-circle"></i> <span id="appVersionDisplay">v0.0</span>
    </div>

    <div class="modal-overlay" id="updatesModal" style="z-index: 12000;">
        <div class="modal" style="max-width: 500px; max-height: 80vh;">
            <div class="modal-header">
                <h3><i class="bi bi-rocket-takeoff" style="color: var(--primary);"></i> Histórico de Versões</h3>
                <button class="btn" style="background:transparent; color:var(--text-main); padding:0; width:30px;" onclick="closeModal('updatesModal')"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="modal-body" style="padding-top: 25px;">
                <div id="updatesTimeline" class="timeline">
                    </div>
                
                <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="closeModal('updatesModal')">Entendi</button>
            </div>
        </div>
    </div>
<script src="js/financeiro.js"></script>
        <script>
    function processarHolerite(bruto, emprestimos) {
        let inss = 0;
        if (bruto <= 1412.00) inss = bruto * 0.075;
        else if (bruto <= 2666.68) inss = (1412 * 0.075) + ((bruto - 1412) * 0.09);
        else if (bruto <= 4000.03) inss = (1412 * 0.075) + ((2666.68 - 1412) * 0.09) + ((bruto - 2666.68) * 0.12);
        else if (bruto <= 7786.02) inss = (1412 * 0.075) + ((2666.68 - 1412) * 0.09) + ((4000.03 - 2666.68) * 0.12) + ((bruto - 4000.03) * 0.14);
        else inss = 908.85 + ((bruto - 7786.02) * 0.14);
        if (inss > 908.85) inss = 908.85;

        const baseIrrf = bruto - inss;
        let irrf = 0;
        if (baseIrrf <= 2259.20) irrf = 0; 
        else if (baseIrrf <= 2826.65) irrf = (baseIrrf * 0.075) - 169.44;
        else if (baseIrrf <= 3751.05) irrf = (baseIrrf * 0.15) - 381.44;
        else if (baseIrrf <= 4664.68) irrf = (baseIrrf * 0.225) - 662.77;
        else irrf = (baseIrrf * 0.275) - 896.00;
        if (irrf < 0) irrf = 0;
        const totalEmprestimos = emprestimos.reduce((acc, emp) => acc + emp.valorParcela, 0);
        const liquido = bruto - inss - irrf - totalEmprestimos;
        const transacoes = [];
        emprestimos.forEach(emp => {
            transacoes.push({ 
                tipo: 'EMPRESTIMO_CONSIGNADO',
                descricao: `Desc. Empréstimo: ${emp.nome}`, 
                valor: emp.valorParcela, 
                idEmprestimoRelacionado: emp.id 
            });
        });

        return { bruto, inss, irrf, totalEmprestimos, liquido, transacoes };
    }
    const APP_VERSION = 'v1.0.0'
    const CHANGELOG = [
        {
            version: 'v1.0.0',
            date: '12/01/2026',
            title: 'Lançamento Oficial (Beta Pública)',
            items: [
                'Início do ciclo oficial v1.0.',
                'Sistema consolidado com Gestão, Renda e Investimentos.',
                'Integração completa de Ouvidoria, Feedback e Terminal.',
                'Segurança de dados e funcionalidade 100% Offline.'
            ]
        },
        {
            version: 'Fase Beta',
            date: 'Jan/2026',
            title: 'Histórico de Desenvolvimento',
            items: [
                'Ajustes de Segurança: Reset individual e proteção de dados.',
                'Correções: Cálculo de INSS/IRRF no holerite.',
                'Novidades: Simulador de Juros, Gráficos e Terminal de Comandos.',
                'Base: Criação do sistema de Backup JSON e Temas.'
            ]
        }
    ];

    const Updates = {
        init: () => {
            document.getElementById('appVersionDisplay').innerText = APP_VERSION;
            const lastSeenVersion = StorageManager.load('capitalis_last_version');
            const tutorialDone = StorageManager.load('capitalis_tutorial_version');
            Updates.renderList();
            if (tutorialDone && lastSeenVersion !== APP_VERSION) {
                setTimeout(() => {
                    document.getElementById('updatesModal').style.display = 'flex';
                    StorageManager.save('capitalis_last_version', APP_VERSION);
                }, 1000);
            } else if (!lastSeenVersion) {
                StorageManager.save('capitalis_last_version', APP_VERSION);
            }
        },

        renderList: () => {
            const container = document.getElementById('updatesTimeline');
            container.innerHTML = '';

            CHANGELOG.forEach((log, index) => {
                const isLatest = index === 0;
                
                let html = `
                <div class="timeline-item ${isLatest ? 'latest' : ''}">
                    <div class="timeline-dot"></div>
                    <div class="version-title">
                        ${log.version} 
                        ${isLatest ? '<span class="badge-new">NOVO</span>' : ''}
                    </div>
                    <span class="version-date">${log.date} - ${log.title}</span>
                    <div class="version-desc">
                        <ul>
                            ${log.items.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        },

        openHistory: () => {
            document.getElementById('updatesModal').style.display = 'flex';
        }
    };
        const Feedback = {
        trackAction: () => {
            if(StorageManager.load('has_rated') === 'true') return;
            let count = parseInt(StorageManager.load('action_counter') || 0);
            count++;
            StorageManager.save('action_counter', count);
            if(count === 3) {
                setTimeout(() => {
                    document.getElementById('feedbackModal').style.display = 'flex';
                }, 1500); 
            }
        },

        showInput: () => {
            document.getElementById('feedbackComment').style.display = 'block';
        },

        send: () => {
            const starEl = document.querySelector('input[name="rating"]:checked');
            if(!starEl) return alert("Por favor, selecione as estrelas primeiro!");
            
            const stars = starEl.value;
            const text = document.getElementById('feedbackText').value;
            
            Logger.log('Avaliação', `⭐ ${stars} Estrelas - Msg: ${text}`);
            
            alert('Recebemos seu feedback. A equipe Capitalis agradece!');
            StorageManager.save('has_rated', 'true'); 
            closeModal('feedbackModal');
        },

        later: () => {
            localStorage.setItem('capitalis_action_counter', 0);
            document.getElementById('feedbackModal').style.display = 'none';
        },

        forceTest: () => {
            localStorage.removeItem('capitalis_rated');
            localStorage.setItem('capitalis_action_counter', 3);
            Feedback.trackAction();
        }
    };
    
    const StorageManager = {
        getPrefix: () => {
            try {
                const session = JSON.parse(sessionStorage.getItem('capitalis_session'));
                if (session && session.email && session.email.includes('@')) {
                    return `user_${session.email.replace(/[^a-zA-Z0-9]/g, '')}_`;
                }
                if (session && session.name) {
                    return `user_${session.name.replace(/[^a-zA-Z0-9]/g, '').toLowerCase()}_`;
                }
                return 'user_guest_';
            } catch (e) {
                return 'user_guest_';
            }
        },
        save: (key, data) => {
            try {
                const globalKeys = ['capitalis_theme']; 
                
                if (globalKeys.includes(key)) {
                    localStorage.setItem(key, typeof data === 'string' ? data : JSON.stringify(data));
                } else {
                    const finalKey = StorageManager.getPrefix() + key;
                    localStorage.setItem(finalKey, JSON.stringify(data));
                }
            } catch (e) {
                alert('Erro: Seu armazenamento está cheio!');
            }
        },
        load: (key) => {
            try {
                const globalKeys = ['capitalis_theme'];
                let finalKey = key;
                
                if (!globalKeys.includes(key)) {
                    finalKey = StorageManager.getPrefix() + key;
                }

                const data = localStorage.getItem(finalKey);
                try { return data ? JSON.parse(data) : null; } 
                catch (e) { return data; } 
            } catch (e) { return null; }
        },
        emergencySave: () => {},
        getUserKeys: () => {
            const prefix = StorageManager.getPrefix();
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                if (k.startsWith(prefix)) keys.push(k);
            }
            return keys;
        }
    };

    const Security = {
        sanitize: (str) => {
            if (typeof str !== 'string') return str;
            return str.replace(/[&<>"'/]/g, (s) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '/': '&#x2F;' })[s]);
        },
        autoLock: () => {
            let timer; const logoutTime = 600000;
            const resetTimer = () => { clearTimeout(timer); timer = setTimeout(() => { alert("Sessão expirada por segurança."); sessionStorage.removeItem('capitalis_session'); window.location.replace('redir.html'); }, logoutTime); };
            window.onload = resetTimer; document.onmousemove = resetTimer; document.onkeypress = resetTimer; document.ontouchstart = resetTimer; 
        }
    };

    const AdSystem = {
        checkAccess: () => {
            if(document.body.classList.contains('tutorial-active')) return;
            const expiry = StorageManager.load('capitalis_access_expiry'); 
            const now = Date.now();
            
            if (!expiry || now > parseInt(expiry)) {
                AdSystem.lockScreen();
            } else {
                AdSystem.unlockScreen();
                AdSystem.startTimer(parseInt(expiry));
            }
        },
        lockScreen: () => {
            document.getElementById('adLockOverlay').style.display = 'flex';
            document.getElementById('timeRemaining').innerText = "Expirado";
            document.getElementById('freeTimerBadge').style.borderColor = 'var(--danger)';
            document.getElementById('freeTimerBadge').style.color = 'var(--danger)';
        },
        unlockScreen: () => {
            document.getElementById('adLockOverlay').style.display = 'none';
        },
        watchAd: () => {
            const btn = document.getElementById('btnWatchAd');
            const bar = document.getElementById('adProgressBar');
            const fill = document.getElementById('adProgressFill');
            const txt = document.getElementById('adStatusText');

            btn.style.display = 'none';
            bar.style.display = 'block';
            txt.style.display = 'block';

            if (window.admob) {
                AdSystem.simulateAd(fill);
            } else {
                AdSystem.simulateAd(fill);
            }
        },
        simulateAd: (fillElement) => {
            let width = 0;
            const interval = setInterval(() => {
                width += 1;
                fillElement.style.width = width + '%';
                if (width >= 100) {
                    clearInterval(interval);
                    AdSystem.grantAccess();
                }
            }, 100); 
        },
        grantAccess: () => {
            const accessTime = 43200000; 
            const expiry = Date.now() + accessTime; 
            StorageManager.save('capitalis_access_expiry', expiry);
            alert("Sucesso! Acesso total liberado por 12 horas. Aproveite! ;)");
            location.reload(); 
        },
        startTimer: (expiryTime) => {
            const el = document.getElementById('timeRemaining');
            const badge = document.getElementById('freeTimerBadge');
            
            setInterval(() => {
                const now = Date.now();
                const diff = expiryTime - now;
                
                if (diff <= 0) {
                    el.innerText = "00:00";
                    AdSystem.checkAccess(); 
                    return;
                }

                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                
                el.innerText = `${hours}h ${minutes}m`;
                
                if(hours < 1) {
                    badge.style.borderColor = 'var(--warning)';
                    badge.style.color = 'var(--warning)';
                } else {
                    badge.style.borderColor = 'var(--success)';
                    badge.style.color = 'var(--success)';
                }
            }, 1000); 
        }
    };

    function parseMoneyInput(value) {
        if(!value) return 0; if(typeof value === 'number') return value;
        let clean = value.toString().replace(/[^\d.,]/g, '');
        if(clean.includes(',')) clean = clean.replace(/\./g, '').replace(',', '.'); else clean = clean.replace(/\./g, '');
        const floatVal = parseFloat(clean); return isNaN(floatVal) ? 0 : floatVal;
    }
    let startY = 0; let isPulling = false; 
    const mainContent = document.getElementById('mainContent'); 
    const ptrLoader = document.getElementById('ptr-loader'); 
    const ptrSpinner = document.getElementById('ptr-spinner');

    window.addEventListener('touchstart', (e) => { 
        if(document.getElementById('view-tools').classList.contains('active-view')) return;
        if (window.scrollY === 0) { startY = e.touches[0].pageY; isPulling = true; } 
    }, {passive: true});

    window.addEventListener('touchmove', (e) => { 
        if (!isPulling) return; 
        if(document.getElementById('view-tools').classList.contains('active-view')) return;
        const y = e.touches[0].pageY; const diff = y - startY; 
        if (diff > 50 && window.scrollY === 0) { 
            const move = Math.min((diff - 50) * 0.25, 200); 
            mainContent.style.transform = `translateY(${move}px)`; 
            ptrLoader.style.top = `${move - 40}px`; 
            ptrSpinner.style.transform = `rotate(${move * 5}deg)`; 
        } 
    }, {passive: true});

    window.addEventListener('touchend', () => { 
        if (!isPulling) return; isPulling = false; 
        const currentY = parseInt(mainContent.style.transform.replace(/[^0-9]/g, '') || 0); 
        if (currentY > 80) { 
            ptrLoader.style.top = '20px'; 
            ptrSpinner.classList.add('ptr-spinning'); 
            setTimeout(() => { location.reload(); }, 800); 
        } else { 
            mainContent.style.transform = ''; ptrLoader.style.top = '-60px'; 
        } 
    });
    const Tutorial = {
        currentStep: 0,
        init: () => {
            if (StorageManager.load('capitalis_tutorial_version') !== APP_VERSION) {
                document.body.classList.add('tutorial-active');
                document.getElementById('tutorialBubble').style.display = 'flex';
                Tutorial.showStep(0);
                return true; 
            }
            return false; 
        },
        showStep: (stepIndex) => {
            Tutorial.currentStep = stepIndex;
            const container = document.getElementById('tutorialContent');
            const session = JSON.parse(sessionStorage.getItem('capitalis_session')) || {name: 'Usuário'};
            const userName = session.name.split(' ')[0];
            let html = ''; let viewToSwitch = '';
            
            switch(stepIndex) {
                case 0: 
                    html = `<div class="tutorial-header"><h2><i class="bi bi-robot"></i> Assistente Capitalis</h2><button class="close-tutorial" onclick="Tutorial.skip()"><i class="bi bi-x-lg"></i></button></div><p style="color:var(--text-muted); font-size:0.9rem;">Olá <strong>${userName}</strong>, seja bem-vindo ao painel financeiro da Capitalis Solution. Vamos fazer um tour pelo aplicativo?</p>`; 
                    break;
                case 1: viewToSwitch = 'finance'; html = `<div class="tutorial-header"><h2><i class="bi bi-cash-coin"></i> Gestão de Gastos</h2><button class="close-tutorial" onclick="Tutorial.skip()"><i class="bi bi-x-lg"></i></button></div><p style="color:var(--text-muted); font-size:0.9rem;">Nessa aba você poderá controlar seus gastos, extratos completos de despesas e muito mais!</p>`; break;
                case 2: viewToSwitch = 'income'; html = `<div class="tutorial-header"><h2><i class="bi bi-graph-up-arrow"></i> Minha Renda</h2><button class="close-tutorial" onclick="Tutorial.skip()"><i class="bi bi-x-lg"></i></button></div><p style="color:var(--text-muted); font-size:0.9rem;">Você pode adicionar novas rendas, e acompanhar tanto por gráfico.</p>`; break;
                case 3: viewToSwitch = 'invest'; html = `<div class="tutorial-header"><h2><i class="bi bi-rocket-takeoff"></i> Investimentos</h2><button class="close-tutorial" onclick="Tutorial.skip()"><i class="bi bi-x-lg"></i></button></div><p style="color:var(--text-muted); font-size:0.9rem;">Acesse o painel de Investimentos para monitorar sua carteira de ativos e reservas financeiras.</p>`; break;
                case 4: viewToSwitch = 'assets'; html = `<div class="tutorial-header"><h2><i class="bi bi-bank"></i> Patrimônio</h2><button class="close-tutorial" onclick="Tutorial.skip()"><i class="bi bi-x-lg"></i></button></div><p style="color:var(--text-muted); font-size:0.9rem;">Em Patrimônio, você tem a visão global de bens duráveis e o controle de empréstimos ativos.</p>`; break;
                case 5: viewToSwitch = 'strategy'; html = `<div class="tutorial-header"><h2><i class="bi bi-clipboard-data"></i> Estratégia</h2><button class="close-tutorial" onclick="Tutorial.skip()"><i class="bi bi-x-lg"></i></button></div><p style="color:var(--text-muted); font-size:0.9rem;">Defina metas de sobra mensal e organize a prioridade de pagamentos.</p>`; break;
                case 6: viewToSwitch = 'tools'; html = `<div class="tutorial-header"><h2><i class="bi bi-terminal"></i> Terminal Capitalis</h2><button class="close-tutorial" onclick="Tutorial.skip()"><i class="bi bi-x-lg"></i></button></div><p style="color:var(--text-muted); font-size:0.9rem;">Interaja com o Assistente Virtual para automação de processos financeiros.</p>`; break;
                case 7: 
                    viewToSwitch = 'logs'; 
                    html = `<div class="tutorial-header"><h2 style="color:var(--danger)"><i class="bi bi-exclamation-triangle-fill"></i> ATENÇÃO MÁXIMA</h2><button class="close-tutorial" onclick="Tutorial.skip()"><i class="bi bi-x-lg"></i></button></div>
                    <p style="font-size:0.9rem; margin-bottom:10px;"><strong>LEIA COM ATENÇÃO:</strong></p>
                    <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:10px;">Este aplicativo funciona 100% offline. <strong>NÓS NÃO TEMOS ACESSO AOS SEUS DADOS</strong>.</p>
                    <p style="font-size:0.85rem; background:rgba(248, 81, 73, 0.1); border:1px solid var(--danger); padding:10px; border-radius:8px; color:var(--danger); font-weight:700;">
                    É de sua TOTAL RESPONSABILIDADE realizar backups regulares (Botão "Backup JSON"). Se você limpar o cache do navegador ou perder o dispositivo sem ter o arquivo de backup, SEUS DADOS SERÃO PERDIDOS PARA SEMPRE.</p>`; 
                    break;
                case 8: 
                    html = `<div class="tutorial-header"><h2><i class="bi bi-shield-check"></i> Finalização</h2></div>
                    <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:15px;">Para começar a usar o Capitalis com segurança, por favor leia nossos Termos de Uso e Política de Privacidade.</p>
                                        <div style="font-size:0.75rem; text-align:center; opacity:0.7; margin-bottom: 10px;"></div>`; 
                    break;
            }
            if(viewToSwitch) { switchView(viewToSwitch); }
            let dots = '<div class="step-dots">'; for(let i=0; i<=8; i++) dots += `<div class="step-dot ${i === stepIndex ? 'active' : ''}"></div>`; dots += '</div>';
            
            let btn = stepIndex === 8 
                ? `<button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="Tutorial.openTerms()">Ler Termos de Uso</button>` 
                : `<div style="display:flex; gap:10px; margin-top:10px;"><button class="btn" style="flex:1; background:rgba(255,255,255,0.1);" onclick="Tutorial.skip()">Pular</button><button class="btn btn-primary" style="flex:1" onclick="Tutorial.showStep(${stepIndex + 1})">Próximo</button></div>`;
            
            container.innerHTML = html + dots + btn;
        },
        skip: () => { 
            if(confirm("Ao pular o tutorial, você declara que LEU e CONCORDA automaticamente com os Termos de Uso e Política de Privacidade do Capitalis.\n\nDeseja continuar?")) Tutorial.acceptTerms(); 
        },
        openTerms: () => {
            document.getElementById('termsModal').style.display = 'flex';
        },
        acceptTerms: () => {
            document.getElementById('termsModal').style.display = 'none';
            Tutorial.finish();
        },
        finish: () => { 
            StorageManager.save('capitalis_tutorial_version', APP_VERSION); 
            document.getElementById('tutorialBubble').style.display = 'none'; 
            document.body.classList.remove('tutorial-active');
            switchView('finance', document.querySelector(`.nav-item[onclick*="'finance'"]`)); 
            AdSystem.checkAccess();
        }
    };
    const Invest = {
        getData: () => StorageManager.load('capitalis_investments') || [],
        getReserve: () => {
            const data = StorageManager.load('capitalis_reserve');
            if(!data) return { type: 'single', items: [{ inst: 'Não definido', val: 0 }] };
            if(Array.isArray(data.items)) return data; 
            return { type: 'single', items: [{ institution: data.institution || 'Não definido', val: data.value || 0 }] };
        },
        tempMultiList: [],
        toggleMultipleReserves: () => {
            const isMulti = document.getElementById('hasMultipleReserves').checked;
            document.getElementById('singleReserveContainer').style.display = isMulti ? 'none' : 'block';
            document.getElementById('multiReserveContainer').style.display = isMulti ? 'block' : 'none';
            if(isMulti) {
                const current = Invest.getReserve();
                Invest.tempMultiList = current.type === 'multi' ? [...current.items] : (current.items[0].val > 0 ? [ ...current.items ] : []);
                Invest.renderMultiList();
            }
        },
        renderMultiList: () => {
            const list = Invest.tempMultiList;
            const container = document.getElementById('multiReserveList');
            container.innerHTML = '';
            if(list.length === 0) { container.innerHTML = '<div style="text-align:center; color:var(--text-muted); font-size:0.8rem; padding:10px;">Nenhum item adicionado.</div>'; return; }
            list.forEach((item, index) => {
                container.innerHTML += `<div class="multi-reserve-item"><div><div class="multi-reserve-name">${Security.sanitize(item.inst)}</div><div class="multi-reserve-obj">${item.obj ? Security.sanitize(item.obj) : 'Geral'}</div></div><div style="text-align:right;"><div class="multi-reserve-val">R$ ${item.val.toLocaleString('pt-BR')}</div><button style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:0.7rem;" onclick="Invest.removeMultiItem(${index})">Remover</button></div></div>`;
            });
        },
        addMultiItem: () => {
            const inst = document.getElementById('multiResInst').value;
            const val = parseMoneyInput(document.getElementById('multiResVal').value);
            const obj = document.getElementById('multiResObj').value;
            if(!inst || val <= 0) return alert('Preencha instituição e valor.');
            Invest.tempMultiList.push({ inst, val, obj });
            document.getElementById('multiResInst').value = '';
            document.getElementById('multiResVal').value = '';
            document.getElementById('multiResObj').value = '';
            Invest.renderMultiList();
        },
        removeMultiItem: (idx) => { Invest.tempMultiList.splice(idx, 1); Invest.renderMultiList(); },
        saveReserve: () => {
            const isMulti = document.getElementById('hasMultipleReserves').checked;
            let dataToSave;
            if(isMulti) { dataToSave = { type: 'multi', items: Invest.tempMultiList }; } 
            else {
                const inst = document.getElementById('resInstitution').value;
                const val = parseMoneyInput(document.getElementById('resValue').value);
                dataToSave = { type: 'single', items: [{ inst, val, obj: 'Geral' }] };
            }
            StorageManager.save('capitalis_reserve', dataToSave);
            closeModal('reserveModal'); Invest.render();
        },
        openReserveModal: () => {
            const res = Invest.getReserve();
            const isMulti = res.type === 'multi';
            document.getElementById('hasMultipleReserves').checked = isMulti;
            Invest.toggleMultipleReserves();
            if(!isMulti) {
                document.getElementById('resInstitution').value = res.items[0].inst !== 'Não definido' ? res.items[0].inst : '';
                document.getElementById('resValue').value = res.items[0].val > 0 ? res.items[0].val : '';
            } else {
                Invest.tempMultiList = [...res.items];
                Invest.renderMultiList();
            }
            document.getElementById('reserveModal').style.display = 'flex';
        },
        save: (data) => { StorageManager.save('capitalis_investments', data); Invest.render(); },
        
        add: () => {
            const name = document.getElementById('invName').value;
            const type = document.getElementById('invType').value;
            const amount = parseMoneyInput(document.getElementById('invAmount').value);
            if(!name || amount <= 0) return alert('Inválido.');
            const debit = document.getElementById('debitFromFinance').checked;
            if (debit) {
                const saldoAtual = Assistant.getLiquidBalance();
                if (amount > saldoAtual) { return alert(`Saldo insuficiente para realizar este aporte!\n\nSaldo atual: R$ ${saldoAtual.toLocaleString('pt-BR')}\nValor do aporte: R$ ${amount.toLocaleString('pt-BR')}\n\nO registro foi cancelado.`); }
            }
            const list = Invest.getData();
            list.push({ id: Date.now(), name, type, amount, date: new Date().toLocaleDateString('pt-BR') });
            Invest.save(list);
            if(debit) { Finance.add(`Aporte: ${name}`, amount, 'Investimento'); }
            closeModal('investAddModal');
            Logger.log('Novo investimento', `${name} - R$ ${amount}`);
            Feedback.trackAction();
        },
        remove: (id) => { if(confirm('Deseja remover seu investimento?')) Invest.save(Invest.getData().filter(i => i.id !== id)); },
        getIcon: (type) => { switch(type) { case 'Renda Fixa': return '<i class="bi bi-graph-up-arrow"></i>'; case 'Ações': return '<i class="bi bi-building"></i>'; case 'Cripto': return '<i class="bi bi-currency-bitcoin"></i>'; case 'Reserva': return '<i class="bi bi-shield-check"></i>'; default: return '<i class="bi bi-wallet2"></i>'; } },
        getTypeClass: (type) => { switch(type) { case 'Renda Fixa': return 'type-renda-fixa'; case 'Ações': return 'type-acoes'; case 'Cripto': return 'type-cripto'; default: return ''; } },
        openAddModal: () => document.getElementById('investAddModal').style.display = 'flex',
        render: () => {
            const list = Invest.getData(); const el = document.getElementById('investList'); el.innerHTML = '';
            let types = {}; let totalList = 0; 
            list.forEach(i => {
                totalList += i.amount; 
                types[i.type] = (types[i.type] || 0) + i.amount;
                el.innerHTML += `<div class="asset-card ${Invest.getTypeClass(i.type)}"><div class="asset-header"><div class="asset-icon-box">${Invest.getIcon(i.type)}</div><div class="asset-pill">${i.type}</div></div><div class="asset-body"><h4>${Security.sanitize(i.name)}</h4><div class="asset-val blur-sensitive">R$ ${i.amount.toLocaleString('pt-BR')}</div><div class="asset-date">Aportado em: ${i.date}</div></div><button class="asset-delete-btn" onclick="Invest.remove(${i.id})"><i class="bi bi-trash"></i></button></div>`;
            });
            const res = Invest.getReserve();
            let totalRes = 0;
            res.items.forEach(i => totalRes += i.val);
            document.getElementById('reserveVal').innerText = totalRes.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            
            if (res.type === 'multi' && res.items.length > 1) {
                document.getElementById('reserveLoc').innerHTML = `<span style="cursor:pointer; text-decoration:underline; color:var(--primary);" onclick="Invest.openReserveModal()">${res.items.length} Locais (conferir detalhes)</span>`;
            } else {
                document.getElementById('reserveLoc').innerText = res.items[0].inst;
            }

            const grandTotal = totalList + totalRes;
            document.getElementById('totalInvestChart').innerText = grandTotal.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            if (totalRes > 0) { types['Reserva'] = (types['Reserva'] || 0) + totalRes; }
            if(grandTotal > 0) {
                const colors = { 'Renda Fixa': 'var(--chart-1)', 'Ações': 'var(--chart-2)', 'Cripto': 'var(--chart-3)', 'Outros': 'var(--chart-4)', 'Reserva': 'var(--invest-gold)' };
                let gradientStr = ''; let currentDeg = 0; let legendHtml = '';
                Object.keys(types).forEach(type => {
                    const deg = (types[type] / grandTotal) * 360; 
                    const color = colors[type] || 'var(--text-muted)';
                    gradientStr += `${color} ${currentDeg}deg ${currentDeg + deg}deg, `; 
                    currentDeg += deg;
                    const pct = ((types[type] / grandTotal) * 100).toFixed(0);
                    legendHtml += `<div class="legend-item"><div class="dot" style="background:${color}"></div>${type} (${pct}%)</div>`;
                });
                document.getElementById('pieChart').style.background = `conic-gradient(${gradientStr.slice(0, -2)})`; 
                document.getElementById('pieLegend').innerHTML = legendHtml;
                const estYield = grandTotal * 0.008; 
                document.getElementById('yieldEst').innerText = `+ ${estYield.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}`;
            } else {
                document.getElementById('pieChart').style.background = 'var(--border-color)'; 
                document.getElementById('pieLegend').innerHTML = '<span style="font-size:0.7rem;">Sem dados</span>';
                document.getElementById('yieldEst').innerText = '+ R$ 0,00';
            }
            Invest.updateSim();
        },
        updateSim: () => {
            const init = parseFloat(document.getElementById('simM').value);
            const years = parseFloat(document.getElementById('simY').value);
            document.getElementById('simM_disp').innerText = init.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            document.getElementById('simY_disp').innerText = years + ' Anos';
            const monthlyRate = 0.008; const months = years * 12;
            const fv = init * ( (Math.pow(1 + monthlyRate, months) - 1) / monthlyRate );
            const totalInvested = init * months; const interest = fv - totalInvested;
            document.getElementById('simResult').innerText = fv.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            document.getElementById('simInterest').innerText = `Juros: + ${interest.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}`;
        }
    };

    const Logger = {
        getLogs: () => StorageManager.load('capitalis_logs') || [],
        log: (action, desc) => { const session = JSON.parse(sessionStorage.getItem('capitalis_session')) || { name: 'Desconhecido' }; const now = new Date(); const logs = Logger.getLogs(); logs.unshift({ id: Date.now(), time: now.toLocaleDateString('pt-BR') + ' ' + now.toLocaleTimeString('pt-BR'), user: session.name, action, desc }); if(logs.length > 500) logs.pop(); StorageManager.save('capitalis_logs', logs); if(document.getElementById('view-logs').classList.contains('active-view')) renderLogs(); },
        clear: () => { if(confirm('Apagar logs?')) { StorageManager.save('capitalis_logs', []); renderLogs(); } },
        export: () => { const logs = Logger.getLogs(); if(logs.length === 0) return alert('Sem logs.'); const blob = new Blob([logs.map(l => `[${l.time}] ${l.user} - ${l.action}: ${l.desc}`).join('\n')], { type: 'text/plain' }); const a = document.createElement('a'); a.href = window.URL.createObjectURL(blob); a.download = `Capitalis_Logs.txt`; a.click(); }
    };

    const Assets = {
        currentAssetId: null,
        getData: () => StorageManager.load('capitalis_assets_v2') || [],
        getBigGoals: () => StorageManager.load('capitalis_big_goals') || [],
        save: (data) => { StorageManager.save('capitalis_assets_v2', data); Assets.render(); },
        render: () => {
            const data = Assets.getData(); 
            const container = document.getElementById('assetsContainer'); 
            if(container) {
                container.innerHTML = '';
                if (data.length === 0) container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: var(--text-muted); padding: 20px;">Nenhum ativo cadastrado ainda.</div>';
                else data.forEach(asset => {
                    const isPayable = asset.type === 'payable';
                    container.innerHTML += `
                    <div class="card" onclick="Assets.manageAsset(${asset.id})" style="cursor:pointer; border:1px solid var(--border-color);">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div class="card-label" style="color:${isPayable ? '#0066FF' : '#238636'}">${isPayable ? 'Pagamento em andamento' : 'Recebimento em andamento'}</div>
                            <button class="btn" style="padding:0; color:var(--danger);" onclick="Assets.remove(${asset.id}); event.stopPropagation();"><i class="bi bi-trash"></i></button>
                        </div>
                        <div class="card-val blur-sensitive" style="font-size: 1.2rem;">${asset.value.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}/mês</div>
                        <div style="font-size: 0.9rem; font-weight: 500; margin-bottom: 5px; color:var(--text-main);">${Security.sanitize(asset.name)}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:5px;">
                            ${isPayable ? `Parcela ${asset.current}/${asset.total}` : `Restam ${asset.total - asset.current}`}
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${(asset.current / asset.total) * 100}%; background-color: ${isPayable ? '#0066FF' : '#238636'};"></div>
                        </div>
                    </div>`;
                });
            }
            const goals = Assets.getBigGoals(); 
            const goalsContainer = document.getElementById('bigGoalsContainer'); 
            if(goalsContainer) {
                goalsContainer.innerHTML = '';
                if (goals.length === 0) goalsContainer.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: var(--text-muted); padding: 20px;">Nenhuma meta definida ainda.</div>';
                else goals.forEach(g => { 
                    goalsContainer.innerHTML += `
                    <div class="card" style="border:1px solid var(--border-color);">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div class="card-label" style="color:#9b59b6">META: ${Security.sanitize(g.name)}</div>
                            <button class="btn" style="padding:0; color:var(--danger);" onclick="Assets.deleteBigGoal(${g.id})"><i class="bi bi-trash"></i></button>
                        </div>
                        <div class="card-val blur-sensitive" style="font-size:1.2rem; color:#9b59b6;">${g.current.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted);">Alvo: ${g.total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${(g.current / g.total) * 100}%; background-color: #9b59b6;"></div>
                        </div>
                        <button class="btn btn-primary" style="width:100%; margin-top:10px; font-size:0.75rem;" onclick="Assets.addMoneyToGoal(${g.id})">Adicionar valor</button>
                    </div>`; 
                });
            }
            const loanContainer = document.getElementById('loanCardsContainer'); 
            if(loanContainer) {
                const loans = Debts.getData().filter(d => d.type === 'loan'); 
                loanContainer.innerHTML = '';
                if (loans.length === 0) loanContainer.innerHTML = `<div style="grid-column: 1 / -1; text-align: center; color: var(--text-muted); padding: 20px;">Nenhum empréstimo ativo por aqui.</div>`;
                else loans.forEach(l => { 
                    let progress = 0;
                    if(l.installments && l.installments.total > 0) {
                        progress = (l.installments.current / l.installments.total) * 100;
                    }
                    loanContainer.innerHTML += `
                    <div class="card" style="border:1px solid var(--border-color);">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div class="card-label" style="color:var(--info)">EMPRÉSTIMO</div>
                            <button class="btn" style="padding:0; color:var(--danger);" onclick="Debts.remove(${l.id})"><i class="bi bi-trash"></i></button>
                        </div>
                        <div class="card-val blur-sensitive" style="font-size:1.2rem;">${(l.amount || 0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</div>
                        <div style="font-size: 0.9rem; font-weight: 500; margin-bottom: 5px; color:var(--text-main);">${Security.sanitize(l.name)}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted);">
                            ${l.installments && l.installments.total > 0 ? `Parcela ${l.installments.current}/${l.installments.total}` : "Empréstimo ativo"}
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${progress}%; background-color: var(--info);"></div>
                        </div>
                        <div style="font-size:0.75rem; color:var(--danger); margin-top:5px; font-weight:700;">
                            - ${(l.installmentValue || 0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}/mês
                        </div>
                    </div>`; 
                });
            }
        },
        add: () => {
            const name = document.getElementById('assetName').value; 
            const total = parseInt(document.getElementById('assetTotal').value); 
            const value = parseMoneyInput(document.getElementById('assetValue').value);
            const current = parseInt(document.getElementById('assetCurrent').value) || 0;
            if(!name || !total || value <= 0) return alert('Preencha os dados do ativo corretamente.');
            const data = Assets.getData(); 
            data.push({ id: Date.now(), type: document.getElementById('assetType').value, name, current, total, value });
            Assets.save(data); 
            closeModal('assetAddModal'); 
            Logger.log('Ativo criado', `${name}`);
        },
        remove: (id) => { if(confirm('Deseja excluir esse ativo?')) { Assets.save(Assets.getData().filter(a => a.id !== id)); } },
        manageAsset: (id) => { 
            Assets.currentAssetId = id; 
            const asset = Assets.getData().find(a => a.id === id); 
            if(asset) { 
                document.getElementById('assetManageTitle').innerText = `Gerenciar: ${asset.name}`; 
                document.getElementById('assetManageModal').style.display = 'flex'; 
                const btnPay = document.getElementById('btnAssetPay'); 
                const btnUndo = document.getElementById('btnAssetUndo'); 
                btnPay.onclick = () => { Assets.processAsset(true); closeModal('assetManageModal'); }; 
                btnUndo.onclick = () => { Assets.processAsset(false); closeModal('assetManageModal'); }; 
            } 
        },
        processAsset: (isForward) => {
            const data = Assets.getData();
            const asset = data.find(a => a.id === Assets.currentAssetId);
            if(!asset) return;
            if (isForward) {
                if(asset.current >= asset.total) return alert('Processo já finalizado!');
                asset.current++; 
                if(asset.type === 'payable') {
                    Finance.add(`Parcela ${asset.name}`, asset.value * -1, 'Gastos por Fora');
                } else {
                    const incData = Income.getData();
                    incData.push({ id: Date.now(), date: new Date().toISOString().slice(0,10), company: `Venda: ${asset.name}`, role: 'Parcela', type: 'Venda', gross: asset.value, net: asset.value, status: 'Pago' });
                    StorageManager.save('capitalis_income', incData);
                    Finance.add(`Recebimento: ${asset.name}`, asset.value, 'Renda');
                }
                alert('Registrado com sucesso! Valor atualizado no saldo.');
            } else {
                if(asset.current <= 0) return alert('Nada para desfazer.');
                if(confirm('Desfazer último andamento? (Nota: O registro financeiro deve ser apagado manualmente)')) {
                    asset.current--;
                    alert('Corrigido!');
                }
            }
            Assets.save(data);
        },
        addMoneyToGoal: (id) => { 
            const val = parseMoneyInput(prompt("Valor a adicionar (R$):")); 
            if(val > 0) { 
                const goals = Assets.getBigGoals(); 
                const goal = goals.find(g => g.id === id); 
                if(goal) { 
                    goal.current += val; 
                    StorageManager.save('capitalis_big_goals', goals); 
                    Finance.add(`Aporte: ${goal.name}`, val * -1, 'Gastos por Fora'); 
                    Assets.render(); 
                } 
            } 
        },
        deleteBigGoal: (id) => { 
            if(confirm('Deseja excluir essa meta?')) { 
                StorageManager.save('capitalis_big_goals', Assets.getBigGoals().filter(g => g.id !== id)); 
                Assets.render(); 
            } 
        }
    };

    function openAddAsset() { document.getElementById('assetAddModal').style.display = 'flex'; }
    function openAddBigGoal() { document.getElementById('bigGoalModal').style.display = 'flex'; }
    function saveBigGoal() { 
        const name = document.getElementById('bgName').value; 
        const total = parseMoneyInput(document.getElementById('bgTotal').value); 
        const current = parseMoneyInput(document.getElementById('bgCurrent').value);
        if(!name || total <= 0) return alert('Preencha o nome e o valor da meta.'); 
        const goals = Assets.getBigGoals(); 
        goals.push({ id: Date.now(), name, total, current }); 
        StorageManager.save('capitalis_big_goals', goals); 
        closeModal('bigGoalModal'); 
        Assets.render(); 
    }

    const Strategy = {
        getGoal: () => StorageManager.load('capitalis_goal') ? parseFloat(StorageManager.load('capitalis_goal')) : 0,
        setGoal: () => { 
            const currentVal = Strategy.getGoal();
            const newVal = prompt("1. Qual o valor da sua meta de sobra? (R$)", currentVal > 0 ? currentVal : ''); 
            if(newVal && !isNaN(parseFloat(newVal))) { 
                const currentDesc = StorageManager.load('capitalis_goal_desc') || '';
                const newDesc = prompt("2. Digite aqui quais são seus objetivos com essa meta.", currentDesc);
                StorageManager.save('capitalis_goal', parseFloat(newVal)); 
                StorageManager.save('capitalis_goal_desc', newDesc ? newDesc : '');
                renderStrategy(); 
            } 
        }
    };

    const Debts = {
        tempId: null, getData: () => StorageManager.load('capitalis_debts') || [], getDismissed: () => JSON.parse(sessionStorage.getItem('capitalis_dismissed')) || [],
        add: (name, amount, type, dueDay, installments, installmentValue = 0) => {
            const safeName = Security.sanitize(name); const list = Debts.getData(); if(list.find(d => d.name.toLowerCase() === safeName.toLowerCase())) return alert('Já existe uma conta com esse ID!');
            list.push({ id: Date.now(), name: safeName, amount: parseMoneyInput(amount), type, dueDay: parseInt(dueDay), installments, installmentValue: parseMoneyInput(installmentValue), lastPaid: null }); StorageManager.save('capitalis_debts', list); renderStrategy(); Assets.render(); closeModal('debtModal'); Logger.log('Nova Conta', `${safeName} (${type})`); return true;
        },
        pay: (id) => { 
            const list = Debts.getData();
            const item = list.find(d => d.id === id);
            if(item) {
                const saldoAtual = Assistant.getLiquidBalance();
                if (item.amount > saldoAtual) {
                    return alert(`Você não tem saldo suficiente em caixa.\n\nVocê precisa de R$ ${item.amount.toLocaleString('pt-BR')} para pagar "${item.name}", mas só tem R$ ${saldoAtual.toLocaleString('pt-BR')} em caixa.`);
                }
                if(confirm(`Confirmar pagamento de: ${item.name}?`)) {
                    Finance.add(`Pagamento: ${item.name}`, item.amount * -1, item.type === 'essential' ? 'Contas' : 'Dívida');
                    item.lastPaid = new Date().toISOString().slice(0, 7);
                    if(item.type === 'loan' && item.installments) {
                        item.installments.current = parseInt(item.installments.current) + 1;
                        if(item.installments.current > item.installments.total) { alert('Parabéns! Empréstimo quitado.'); }
                    }
                    StorageManager.save('capitalis_debts', list);
                    renderStrategy(); Assets.render(); 
                    if(typeof renderFinance === 'function') renderFinance();

                    Feedback.trackAction();
                }
            }
        },
        remove: (id) => { if(confirm('Deseja excluir a conta sem finalizar o pagamento?')) { StorageManager.save('capitalis_debts', Debts.getData().filter(i => i.id !== id)); renderStrategy(); Assets.render(); closeModal('actionModal'); closeModal('notifModal'); Debts.checkNotifications(); } },
        checkNotifications: () => {
            const list = Debts.getData(); const dismissed = Debts.getDismissed(); const today = new Date().getDate(); const currentMonth = new Date().toISOString().slice(0, 7);
            const urgent = list.filter(d => d.type === 'essential' && (d.dueDay - today <= 5) && d.amount > 0 && d.lastPaid !== currentMonth && !dismissed.includes(d.id));
            const badge = document.getElementById('notifBadge'); const content = document.getElementById('notifContent');
            if(urgent.length > 0) { badge.classList.add('active'); badge.innerText = urgent.length; content.innerHTML = urgent.map(u => `<div class="notif-item" onclick="Debts.openAction('${u.id}', '${u.name}')"><div style="display:flex; justify-content:space-between;"><div><strong style="color:var(--danger)">${u.name}</strong><br><span style="font-size:0.8rem; color:var(--text-muted)">Vence dia ${u.dueDay}</span></div><div style="font-weight:bold;">R$ ${u.amount}</div></div></div>`).join(''); } 
            else { badge.classList.remove('active'); badge.innerText = ''; content.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted)">Tudo tranquilo!</div>'; }
        },
        openAction: (id, name) => { Debts.tempId = parseInt(id); document.getElementById('actionTitle').innerText = name; closeModal('notifModal'); document.getElementById('actionModal').style.display = 'flex'; },
        markAsRead: () => { if(!Debts.tempId) return; const list = Debts.getDismissed(); list.push(Debts.tempId); sessionStorage.setItem('capitalis_dismissed', JSON.stringify(list)); closeModal('actionModal'); Debts.checkNotifications(); },
        deleteFromAction: () => { if(Debts.tempId) Debts.remove(Debts.tempId); }
    };

    const Assistant = {
        state: 'IDLE', tempData: {},
        getLiquidBalance: () => {
            const fixedSalary = parseFloat(StorageManager.load('capitalis_fixed_salary') || 0);
            const transactions = Finance.getData();
            const currentMonth = new Date().toISOString().slice(0, 7);
            const monthTrans = transactions.filter(t => t.date.startsWith(currentMonth));
            let extraIncome = 0; let expenses = 0;
            monthTrans.forEach(t => {
                if (t.amount > 0 && t.cat !== 'Salário') extraIncome += t.amount;
                else if (t.amount < 0) expenses += Math.abs(t.amount);
            });
            return (fixedSalary + extraIncome) - expenses;
        },
        init: () => {
            const input = document.getElementById('cmdInput'); const term = document.getElementById('assistTerminal');
            const newInp = input.cloneNode(true); input.parentNode.replaceChild(newInp, input);
            newInp.addEventListener('keydown', (e) => { if (e.key === 'Enter') { const val = Security.sanitize(newInp.value); newInp.value = ''; if (val.trim()) Assistant.processInput(val); } });
            term.innerHTML = ''; Assistant.print('<em>Iniciando central de comandos Capitalis...</em>', 'sys');
            const session = JSON.parse(sessionStorage.getItem('capitalis_session')); const name = session ? session.name.split(' ')[0] : 'Usuário';
            setTimeout(() => { Assistant.print(`Olá, <strong>${name}</strong>.`, 'success'); Assistant.showMainMenu(); }, 600);
        },
        showMainMenu: () => {
            const liquid = Assistant.getLiquidBalance(); const color = liquid >= 0 ? '#4caf50' : '#f44336';
            let msg = `Saldo em Conta: <strong style="color:${color}">R$ ${liquid.toLocaleString('pt-BR')}</strong>.<br>`;
            if (liquid <= 0) msg += `<span style="font-size:0.8rem; color:#ff9800;">Atenção: você está sem saldo, clique no botão abaixo para adicionar um salário ou renda extra!</span><br>`;
            msg += `Seja bem-vindo(a) ao assistente de pagamentos da Capitalis, em que posso te ajudar? (selecione as opções)`;
            Assistant.print(msg, 'sys');
            Assistant.appendActions([ { text: '💸 Pagar Conta', action: "pagar" }, { text: '📈 Investir', action: "investir" }, { text: '💰 Salário/Renda', action: "salario" }, { text: '🧾 Nova Despesa', action: "add_conta" }, { text: '🗑️ Limpar Chat', action: "clear_chat" } ]);
            Assistant.state = 'IDLE';
        },
        appendActions: (actions) => {
            const term = document.getElementById('assistTerminal'); const div = document.createElement('div');
            div.className = 'chat-actions-container'; div.style.marginTop = '10px'; div.style.display = 'flex'; div.style.gap = '8px'; div.style.flexWrap = 'wrap';
            actions.forEach(act => { const btn = document.createElement('span'); btn.className = 'chat-tag'; btn.innerHTML = act.text; btn.style.cursor = 'pointer'; btn.onclick = () => Assistant.trigger(act.action); div.appendChild(btn); });
            term.appendChild(div); term.scrollTop = term.scrollHeight;
        },
        trigger: (cmd) => { Assistant.processInput(cmd); },
        print: (msg, type = 'sys') => { const term = document.getElementById('assistTerminal'); const div = document.createElement('div'); div.className = 'msg-' + type; div.innerHTML = msg; term.appendChild(div); term.scrollTop = term.scrollHeight; },
        processSalaryCalculation: (grossVal, loansToDeduct, isSimulation) => {
            const allDebts = Debts.getData();
            const result = processarHolerite(grossVal, loansToDeduct);
            
            // Formatador para Dinheiro
            const fmt = (v) => v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            let msg = '';
            if(isSimulation) { 
                msg = `<strong>🧮 Simulação de Salário</strong><br>`; 
            } else {
                // SALVA O LÍQUIDO NOVO
                StorageManager.save('capitalis_fixed_salary', result.liquido);
                
                msg = `<strong>✅ Salário fixo atualizado!</strong><br>`;

                result.transacoes.forEach(t => {
                    if (t.idEmprestimoRelacionado) {
                        const debt = allDebts.find(d => d.id === t.idEmprestimoRelacionado);
                        if (debt) {
                            debt.lastPaid = new Date().toISOString().slice(0, 7); 
                            if(debt.installments) { 
                                debt.installments.current = parseInt(debt.installments.current) + 1; 
                            }
                        }
                    }
                });
                StorageManager.save('capitalis_debts', allDebts);
                Assets.render();
            }

            msg += `<small>Salário Bruto: R$ ${fmt(result.bruto)}</small><br>`;
            msg += `<small style="color:var(--danger)">(-) INSS: R$ ${fmt(result.inss)}</small><br>`;
            
            if(result.irrf > 0) {
                msg += `<small style="color:var(--danger)">(-) IRRF: R$ ${fmt(result.irrf)}</small><br>`;
            }

            if (result.totalEmprestimos > 0) { 
                msg += `<small style="color:var(--warning)">(-) Empréstimos: R$ ${fmt(result.totalEmprestimos)}</small><br>`; 
            }

            msg += `------------------------------<br>`;
            msg += `💰 <strong>Líquido (Base): R$ ${fmt(result.liquido)}</strong><br><br>`;
            
            if(!isSimulation) {
                const transactions = Finance.getData();
                const currentMonth = new Date().toISOString().slice(0, 7);
                const gastosMes = Math.abs(transactions
                    .filter(t => t.date.startsWith(currentMonth) && t.amount < 0)
                    .reduce((acc, t) => acc + t.amount, 0));
                
                const saldoFinal = result.liquido - gastosMes;

                msg += `<em>Resumo do Caixa:</em><br>`;
                msg += `<small>+ Líquido: R$ ${fmt(result.liquido)}</small><br>`;
                msg += `<small style="color:var(--danger)">- Gastos já lançados: R$ ${fmt(gastosMes)}</small><br>`;
                msg += `<strong>= Saldo Atual: R$ ${fmt(saldoFinal)}</strong>`;
            }

            Assistant.print(msg, isSimulation ? 'info' : 'success');
            
            if(!isSimulation && typeof renderStrategy === 'function') renderStrategy();
            
            if(isSimulation) { 
                Assistant.appendActions([{ text: 'Limpar', action: "clear_chat" }, { text: 'Menu', action: "menu" }]); 
            } else { 
                if(typeof Feedback !== 'undefined' && Feedback.trackAction) Feedback.trackAction();
                Assistant.showMainMenu(); 
            }
        },
        processInput: (text) => {
            const lower = text.toLowerCase().trim();
            if (lower === 'clear_chat') { document.getElementById('assistTerminal').innerHTML = ''; Assistant.state = 'IDLE'; Assistant.showMainMenu(); return; }
            if (['cancelar', 'voltar', 'menu'].includes(lower)) { Assistant.state = 'IDLE'; return Assistant.showMainMenu(); }
            if(!['pagar', 'investir', 'salario', 'add_conta', 'sim', 'não', 'confirm_loan_yes', 'confirm_loan_no', 'simular_salario', 'definir_fixo', 'novo_fixo'].includes(lower) && !lower.startsWith('pay_id_') && !lower.startsWith('sel_id_')) { Assistant.print(text, 'user'); }
            if (Assistant.state === 'IDLE') {
                if (lower === 'pagar') {
                    const liquid = Assistant.getLiquidBalance();
                    if (liquid <= 0) return Assistant.print('Você não tem saldo suficiente. Para continuar com essa operação, será necessário adicionar renda ou salário fixo.', 'err');
                    const debts = Debts.getData(); const currentMonth = new Date().toISOString().slice(0, 7);
                    const pending = debts.filter(d => d.lastPaid !== currentMonth && d.amount > 0);
                    if (pending.length === 0) return Assistant.print('Nenhuma conta pendente.', 'success');
                    Assistant.print(`Saldo: R$ ${liquid.toLocaleString('pt-BR')}. Qual conta você deseja pagar?`, 'sys');
                    const actions = pending.map(d => ({ text: `💸 ${d.name} (R$ ${d.amount})`, action: `pay_id_${d.id}` }));
                    actions.push({ text: 'Cancelar', action: 'cancelar' });
                    Assistant.appendActions(actions);
                    Assistant.state = 'WAITING_PAYMENT_SELECTION';
                    return;
                }
                if (lower === 'investir') {
                    const liquid = Assistant.getLiquidBalance();
                    if (liquid <= 0) return Assistant.print('Verifique seu saldo antes de continuar.', 'err');
                    Assistant.state = 'WAITING_INVEST_AMOUNT';
                    return Assistant.print(`Saldo livre: <strong>R$ ${liquid.toLocaleString('pt-BR')}</strong>. Quanto você deseja investir?`);
                }
                if (lower === 'salario') {
                    const currentFixed = parseFloat(StorageManager.load('capitalis_fixed_salary') || 0);
                    Assistant.print(`Salário fixo atual: <strong>R$ ${currentFixed.toLocaleString('pt-BR')}</strong>.`);
                    Assistant.print('O que deseja fazer?', 'sys');
                    Assistant.appendActions([ { text: '🧮 Simular Bruto (Temporário)', action: 'simular_salario' }, { text: '💾 Definir Novo Salário Fixo', action: 'definir_fixo' }, { text: '➕ Renda Extra', action: 'add_renda_extra' } ]);
                    return;
                }
                if (lower === 'simular_salario') { Assistant.tempData.isSimulation = true; Assistant.state = 'WAITING_GROSS_SALARY'; return Assistant.print('Digite o valor <strong>bruto</strong> para continuar com a simulação:'); }
                if (lower === 'definir_fixo') { Assistant.print('⚠️ <strong>Atenção:</strong> O salário fixo define sua base mensal. Altere apenas se houve mudança real de emprego ou contrato.', 'warn'); Assistant.appendActions([{ text: 'Continuar', action: 'novo_fixo' }, { text: 'Cancelar', action: 'cancelar' }]); return; }
                if (lower === 'novo_fixo') { Assistant.tempData.isSimulation = false; Assistant.state = 'WAITING_GROSS_SALARY'; return Assistant.print('Digite o novo valor <strong>bruto</strong> para continuar com a operação:'); }
                if (lower === 'add_renda_extra') { Assistant.state = 'WAITING_EXTRA_INCOME_DESC'; return Assistant.print('Qual a origem da renda?'); }
                if (lower === 'add_conta') { 
                    const debts = Debts.getData();
                    let msg = 'Essa conta já foi registrada, verifique o nome e tente novamente!<br>';
                    if(debts.length > 0) { debts.forEach((d, index) => { msg += `(ID ${index + 1}) ${d.name}<br>`; }); } 
                    else { msg += 'Nenhuma conta cadastrada ainda!<br>'; }
                    const nextId = debts.length + 1;
                    msg += `<br>Digite o <strong>número do ID</strong> existente para repetir a conta, ou digite um <strong>novo nome</strong> (será ID ${nextId}).`;
                    Assistant.print(msg);
                    Assistant.state = 'WAITING_BILL_ID_OR_NAME'; 
                    return; 
                }
                return Assistant.print('Ainda não tenho conhecimento suficiente para compreender-lo, mas posso tentar ajudar se você me guiar pelos botões.');
            }
            if (Assistant.state === 'WAITING_GROSS_SALARY') {
                const grossVal = parseMoneyInput(text);
                if (!grossVal) return Assistant.print('Valor inválido.');
                const allDebts = Debts.getData();
                const loans = allDebts.filter(d => d.type === 'loan').map(d => ({ id: d.id, nome: d.name, valorParcela: Number(d.installmentValue || 0) }));
                if (loans.length > 0) {
                    const totalLoans = loans.reduce((a, b) => a + b.valorParcela, 0);
                    Assistant.tempData.pendingGross = grossVal;
                    Assistant.tempData.pendingLoans = loans; 
                    Assistant.print(`Identifiquei <strong>${loans.length} empréstimos</strong> (Total: R$ ${totalLoans.toLocaleString('pt-BR')}).<br>Você deseja descontar seu empréstimo na folha de pagamento?`, 'warn');
                    Assistant.appendActions([ { text: 'Sim, desejo descontar direto da folha de pagamento', action: 'confirm_loan_yes' }, { text: 'Não, descontar depois como despesa.', action: 'confirm_loan_no' } ]);
                    Assistant.state = 'WAITING_LOAN_CONFIRMATION';
                    return;
                }
                Assistant.processSalaryCalculation(grossVal, [], Assistant.tempData.isSimulation);
                return;
            }
            if (Assistant.state === 'WAITING_LOAN_CONFIRMATION') {
                const grossVal = Assistant.tempData.pendingGross;
                const loans = Assistant.tempData.pendingLoans;
                const isSim = Assistant.tempData.isSimulation;
                if (lower === 'confirm_loan_yes') { Assistant.processSalaryCalculation(grossVal, loans, isSim); } 
                else { Assistant.print('Certo, estou calculando para abater sem descontar empréstimos.', 'sys'); Assistant.processSalaryCalculation(grossVal, [], isSim); }
                return;
            }
            if (Assistant.state === 'WAITING_PAYMENT_SELECTION') {
                if (lower.startsWith('pay_id_')) {
                    const id = parseInt(lower.replace('pay_id_', ''));
                    const debts = Debts.getData(); const target = debts.find(d => d.id === id);
                    if (target) {
                        const liquid = Assistant.getLiquidBalance();
                        if (liquid < target.amount) return Assistant.print(`Saldo insuficiente.`);
                        Finance.add(`Pagamento: ${target.name}`, target.amount * -1, target.type === 'essential' ? 'Contas' : 'Dívida');
                        target.lastPaid = new Date().toISOString().slice(0, 7);
                        if(target.type === 'loan' && target.installments) target.installments.current++;
                        StorageManager.save('capitalis_debts', debts);
                        if(typeof renderStrategy === 'function') renderStrategy(); Assets.render();
                        Assistant.print(`<strong>${target.name}</strong> pago!`, 'success'); Assistant.showMainMenu();
                    }
                } else Assistant.showMainMenu();
                return;
            }
            if (Assistant.state === 'WAITING_INVEST_AMOUNT') {
                const val = parseMoneyInput(text); const liquid = Assistant.getLiquidBalance();
                if (!val || val <= 0) return Assistant.print('Valor inválido.');
                if (val > liquid) return Assistant.print(`Saldo insuficiente.`);
                Assistant.tempData.investAmount = val;
                Assistant.print(`Valor R$ ${val.toLocaleString('pt-BR')} aceito. Em qual tipo de fundo você deseja investir hoje?`);
                Assistant.appendActions([ { text: '🛡️ Reserva', action: 'dest_reserva' }, { text: '📈 Ações', action: 'dest_acao' }, { text: '🏦 Fixa', action: 'dest_fixa' } ]);
                Assistant.state = 'WAITING_INVEST_DEST';
                return;
            }
            if (Assistant.state === 'WAITING_INVEST_DEST') {
                let typeKey = '';
                if (lower === 'dest_reserva') typeKey = 'Reserva';
                else if (lower === 'dest_acao') typeKey = 'Ações';
                else if (lower === 'dest_fixa') typeKey = 'Renda Fixa';
                else return Assistant.print('Selecione uma opção válida.');
                Assistant.tempData.investType = typeKey;
                Assistant.state = 'WAITING_INVEST_INSTITUTION';
                return Assistant.print(`Certo, ${typeKey}. <strong>Em qual instituição</strong> está guardado? (Ex: Nubank, XP)`);
            }
            if (Assistant.state === 'WAITING_INVEST_INSTITUTION') {
                const institution = Security.sanitize(text);
                const amount = Assistant.tempData.investAmount;
                const type = Assistant.tempData.investType;
                let logName = '';
                if (type === 'Reserva') {
                    logName = `Reserva (${institution})`;
                    const reserveData = Invest.getReserve();
                    const existingItem = reserveData.items.find(i => i.inst.toLowerCase().includes(institution.toLowerCase()));      
                    if (existingItem) { existingItem.val += amount; } 
                    else {
                        if (reserveData.type === 'single' && reserveData.items[0].inst === 'Não definido') { reserveData.items[0].inst = institution; reserveData.items[0].val += amount; } 
                        else { reserveData.type = 'multi'; reserveData.items.push({ inst: institution, val: amount, obj: 'Via assistente' }); }
                    }
                    StorageManager.save('capitalis_reserve', reserveData);
                } else {
                    logName = `${type} - ${institution}`;
                    const invList = Invest.getData();
                    invList.push({ id: Date.now(), name: `${institution} (${type})`, type: type, amount: amount, date: new Date().toLocaleDateString('pt-BR') });
                    Invest.save(invList);
                }
                Finance.add(`Aporte: ${logName}`, amount * -1, 'Investimento'); 
                Invest.render();
                if(typeof renderStrategy === 'function') renderStrategy();
                Assistant.print(`<strong>R$ ${amount.toLocaleString('pt-BR')}</strong> investidos!`, 'success');
                Assistant.showMainMenu();
                return;
            }
            if (Assistant.state === 'WAITING_EXTRA_INCOME_DESC') { Assistant.tempData.incomeDesc = text; Assistant.state = 'WAITING_EXTRA_INCOME_VAL'; return Assistant.print('Qual valor você deseja adicionar?'); }
            if (Assistant.state === 'WAITING_EXTRA_INCOME_VAL') {
                const val = parseMoneyInput(text); if (!val) return Assistant.print('Inválido.');
                Finance.add(Assistant.tempData.incomeDesc, val, 'Adicionar renda extra');
                Assistant.print('Renda adicionada', 'success'); renderStrategy(); Assistant.showMainMenu(); return;
            }
            if (Assistant.state === 'WAITING_BILL_ID_OR_NAME') {
                if (!isNaN(text)) {
                    const idIndex = parseInt(text) - 1;
                    const debts = Debts.getData();
                    if (debts[idIndex]) {
                        Assistant.tempData.newBillName = debts[idIndex].name;
                        Assistant.print(`Selecionado: <strong>${debts[idIndex].name}</strong>. Qual o valor total da sua conta?`);
                        Assistant.state = 'WAITING_BILL_VAL';
                    } else { Assistant.print('Não consegui localizar esse ID, você pode tentar um nome ou um ID diferente.', 'err'); }
                } else {
                    Assistant.tempData.newBillName = text;
                    Assistant.print(`Nova conta: <strong>${text}</strong>. Qual o valor total da sua conta?`);
                    Assistant.state = 'WAITING_BILL_VAL';
                }
                return;
            }
            if (Assistant.state === 'WAITING_BILL_VAL') {
                const val = parseMoneyInput(text); if(!val) return Assistant.print('Inválido.');
                Assistant.tempData.newBillVal = val; Assistant.print('Qual é o dia do vencimento?'); Assistant.state = 'WAITING_BILL_DAY'; return;
            }
            if (Assistant.state === 'WAITING_BILL_DAY') {
                const day = parseInt(text); if(!day || day < 1 || day > 31) return Assistant.print('Dia inválido.');
                Debts.add(Assistant.tempData.newBillName, Assistant.tempData.newBillVal, 'essential', day, null);
                Assistant.print('Sua conta foi registrada com sucesso!', 'success'); Assistant.showMainMenu(); return;
            }
        },
        processPayment: (id) => {
             switchView('tools', document.querySelector(`.nav-item[onclick*="'tools'"]`));
             Assistant.print('Iniciando pagamento...', 'sys');
             Assistant.trigger('pagar');
             setTimeout(() => Assistant.trigger(`pay_id_${id}`), 500);
        }
    };

    const System = {
        backup: () => { 
            const backup = { 
                income: StorageManager.load('capitalis_income'), 
                finance: StorageManager.load('capitalis_finance'), 
                logs: StorageManager.load('capitalis_logs'), 
                assets: StorageManager.load('capitalis_assets_v2'), 
                debts: StorageManager.load('capitalis_debts'), 
                bigGoals: StorageManager.load('capitalis_big_goals'), 
                goal: StorageManager.load('capitalis_goal'), 
                fixo: StorageManager.load('capitalis_fixed_salary'), 
                investments: StorageManager.load('capitalis_investments') 
            }; 
            const a = document.createElement('a'); 
            a.href = window.URL.createObjectURL(new Blob([JSON.stringify(backup)], { type: 'application/json' })); 
            a.download = `Capitalis_Backup_${new Date().toISOString().slice(0,10)}.json`; 
            a.click(); 
        },
        restore: (input) => { 
            const file = input.files[0]; if(!file) return; 
            const reader = new FileReader(); 
            reader.onload = (e) => { 
                try { 
                    const data = JSON.parse(e.target.result); 
                    if(data.income) StorageManager.save('capitalis_income', data.income); 
                    if(data.finance) StorageManager.save('capitalis_finance', data.finance); 
                    if(data.logs) StorageManager.save('capitalis_logs', data.logs); 
                    if(data.assets) StorageManager.save('capitalis_assets_v2', data.assets); 
                    if(data.debts) StorageManager.save('capitalis_debts', data.debts); 
                    if(data.bigGoals) StorageManager.save('capitalis_big_goals', data.bigGoals); 
                    if(data.goal) StorageManager.save('capitalis_goal', data.goal); 
                    if(data.fixo) StorageManager.save('capitalis_fixed_salary', data.fixo); 
                    if(data.investments) StorageManager.save('capitalis_investments', data.investments); 
                    alert('Restaurado com sucesso!'); 
                    location.reload(); 
                } catch(err) { alert('Erro no arquivo de backup.'); } 
            }; 
            reader.readAsText(file); 
        },
        openReset: () => { 
            document.getElementById('resetModal').style.display = 'flex'; 
            const btn = document.getElementById('btnConfirmReset'); 
            btn.disabled = true; 
            btn.style.opacity = '0.5'; 
            let sec = 5; 
            const timer = setInterval(() => { 
                sec--; 
                if(sec <= 0) { 
                    clearInterval(timer); 
                    btn.disabled = false; 
                    btn.style.opacity = '1'; 
                    btn.innerText = 'SIM, APAGAR MINHA CONTA'; 
                } else btn.innerText = `Aguarde ${sec}s...`; 
            }, 1000); 
        },
        confirmReset: () => { 
            const keysToRemove = StorageManager.getUserKeys();
            if (keysToRemove.length > 0) {
                keysToRemove.forEach(k => localStorage.removeItem(k));
            }
            const session = JSON.parse(sessionStorage.getItem('capitalis_session'));
            if(session && session.user) {
                let usersDB = JSON.parse(localStorage.getItem('capitalis_users_db') || '[]');
                usersDB = usersDB.filter(u => u.user.toLowerCase() !== session.user.toLowerCase());
                localStorage.setItem('capitalis_users_db', JSON.stringify(usersDB));
            }
            sessionStorage.removeItem('capitalis_session');
            alert('Sua conta foi apagada com sucesso. Os outros usuários do dispositivo permanecem intactos.');
            window.location.replace('index.html'); 
        }
    };

    function renderIncome() {
        const list = Income.getData();
        const tbody = document.getElementById('incomeTableBody');
        const totalDisplay = document.getElementById('yearTotalDisplay');
        const chartContainer = document.getElementById('incomeChart');
        const filterYear = document.getElementById('incomeYearFilter');
        tbody.innerHTML = '';
        const years = [...new Set(list.map(i => i.date.split('-')[0]))].sort().reverse();
        const currentYear = new Date().getFullYear().toString();
        if (filterYear.options.length === 0) {
            if(years.length === 0) years.push(currentYear);
            years.forEach(y => {
                const opt = document.createElement('option'); opt.value = y; opt.innerText = y; if(y === currentYear) opt.selected = true; filterYear.appendChild(opt);
            });
        }
        const selectedYear = filterYear.value || currentYear;
        const filtered = list.filter(i => i.date.startsWith(selectedYear)).sort((a,b) => new Date(b.date) - new Date(a.date));
        if(filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px; color:var(--text-muted)">Nenhuma renda neste ano.</td></tr>'; } 
        else {
            filtered.forEach(i => {
                const d = i.date.split('-');
                const statusClass = i.status === 'Pago' ? 'badge-pago' : '';
                const statusStyle = i.status !== 'Pago' ? 'color:var(--warning); background:rgba(227, 179, 65, 0.1); padding:2px 6px; border-radius:4px; border:1px solid rgba(227, 179, 65, 0.3); font-size:0.65rem; font-weight:700;' : '';
                let actionBtn = `<button class="btn" style="padding:4px; color:var(--danger);" onclick="Income.remove(${i.id})"><i class="bi bi-trash"></i></button>`;
                if(i.status !== 'Pago') { actionBtn = `<button class="btn" style="padding:4px; color:var(--success); margin-right:5px;" onclick="Income.markAsPaid(${i.id})"><i class="bi bi-check-lg"></i></button>` + actionBtn; }
                tbody.innerHTML += `<tr><td style="color:var(--text-muted); font-family:'JetBrains Mono'">${d[2]}/${d[1]}</td><td>${Security.sanitize(i.company)}</td><td>${Security.sanitize(i.role)}</td><td><span style="background:rgba(47, 129, 247, 0.1); color:var(--primary); padding:2px 6px; border-radius:4px; font-size:0.65rem;">${i.type}</span></td><td style="color:var(--text-muted);">R$ ${i.gross.toLocaleString('pt-BR')}</td><td class="blur-sensitive" style="color:var(--success); font-weight:700;">R$ ${i.net.toLocaleString('pt-BR')}</td><td><span class="${statusClass}" style="${statusStyle}">${i.status}</span></td><td>${actionBtn}</td></tr>`;
            });
        }
        let yearTotal = 0; const monthsData = Array(12).fill(0);
        filtered.forEach(i => { if(i.status === 'Pago') { yearTotal += i.net; const monthIndex = parseInt(i.date.split('-')[1]) - 1; monthsData[monthIndex] += i.net; } });
        totalDisplay.innerText = yearTotal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        chartContainer.innerHTML = ''; const maxVal = Math.max(...monthsData) || 1; const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        monthsData.forEach((val, idx) => {
            const height = (val / maxVal) * 100; const color = val > 0 ? 'var(--success)' : 'var(--border-color)'; const barHeight = val > 0 ? `${Math.max(height, 5)}%` : '4px';
            chartContainer.innerHTML += `<div class="chart-bar-group"><div class="chart-val-top">${val > 0 ? (val/1000).toFixed(1)+'k' : ''}</div><div class="chart-bar" style="height: ${barHeight}; background: ${color}; opacity: ${val > 0 ? 0.8 : 0.2}"></div><div class="chart-label">${monthNames[idx]}</div></div>`;
        });
    }

    const Income = {
        getData: () => StorageManager.load('capitalis_income') || [],
        save: () => { const date = document.getElementById('incDate').value; const company = Security.sanitize(document.getElementById('incCompany').value); const role = Security.sanitize(document.getElementById('incRole').value); const grossInput = document.getElementById('incGross').value; const netInput = document.getElementById('incNet').value; const status = document.getElementById('incStatus').value; if (!date || !grossInput) return alert('Preencha os dados.'); Logger.log('Nova Renda', `${company} - R$ ${netInput}`); const data = Income.getData(); data.push({ id: Date.now(), date, company, role, type: 'Salário', gross: parseMoneyInput(grossInput), net: parseMoneyInput(netInput), status }); StorageManager.save('capitalis_income', data); renderIncome(); closeModal('incomeModal'); Feedback.trackAction(); },
        remove: (id) => { if(confirm('Deseja excluir?')) { StorageManager.save('capitalis_income', Income.getData().filter(i => i.id !== id)); renderIncome(); } },
        markAsPaid: (id) => { if(confirm('Confirmar recebimento de nova renda?')) { const data = Income.getData(); const item = data.find(i => i.id === id); if(item) { item.status = 'Pago'; StorageManager.save('capitalis_income', data); renderIncome(); } } }
    };

    const Finance = {
        getData: () => StorageManager.load('capitalis_finance') || [],
        add: (desc, amountInput, cat) => {
            let val = 0; if (typeof amountInput === 'number') val = amountInput; else val = parseMoneyInput(amountInput);
            if (!desc || val === 0) return alert('Valor ou descrição inválidos.');
            const expenseCategories = ['Aluguel', 'Luz', 'Agua', 'Internet', 'Vivo', 'Fralda', 'Gasolina', 'Mercado', 'Compras na Internet', 'Lazer', 'Contas', 'Dívida', 'Investimento', 'Empréstimo'];
            if (expenseCategories.includes(cat) && val > 0) { val = val * -1; }
            let saveDate = new Date().toISOString().slice(0, 10);
            const currentFilter = document.getElementById('filterMonth') ? document.getElementById('filterMonth').value : null;
            if (currentFilter) { const now = new Date(); const [fYear, fMonth] = currentFilter.split('-'); if (now.getMonth() + 1 != fMonth || now.getFullYear() != fYear) { saveDate = `${currentFilter}-01`; } }
            const data = Finance.getData(); data.unshift({ id: Date.now(), date: saveDate, desc: Security.sanitize(desc), amount: val, cat: cat });
            StorageManager.save('capitalis_finance', data);
            if (typeof renderFinance === 'function') renderFinance(); if (typeof closeModal === 'function') closeModal('transactionModal'); if (typeof renderStrategy === 'function') renderStrategy();
            Logger.log('Financeiro', `Adicionado: ${desc} (${val.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})})`);
        },
        remove: (id) => {
            const data = Finance.getData(); const target = data.find(i => i.id === id);
            if (target) {
                const newData = data.filter(i => i.id !== id); StorageManager.save('capitalis_finance', newData);
                if (target.desc.startsWith('Pagamento:')) {
                    const debtName = target.desc.replace('Pagamento: ', '').trim();
                    const debts = Debts.getData(); const d = debts.find(x => x.name === debtName);
                    if(d) { d.lastPaid = null; StorageManager.save('capitalis_debts', debts); }
                }
                if (typeof renderFinance === 'function') renderFinance(); if (typeof renderStrategy === 'function') renderStrategy();
                const reportModal = document.getElementById('reportModal'); if (reportModal && reportModal.style.display === 'flex' && typeof openMonthlyReport === 'function') { openMonthlyReport(); }
                Logger.log('Financeiro', `Removido: ${target.desc}`);
            }
        }
    };

    function renderStrategy() {
        const list = Finance.getData(); 
        const now = new Date(); 
        const currentMonthStr = now.toISOString().slice(0, 7);
        const todayDay = now.getDate();
        const currentMonthExpenses = list.filter(i => i.date.startsWith(currentMonthStr));
        let total = 0, essential = 0, debt = 0, lifestyle = 0;
        currentMonthExpenses.forEach(i => { 
            if (i.amount < 0) {
                const val = Math.abs(i.amount);
                total += val; 
                if(['Aluguel', 'Luz', 'Agua', 'Mercado', 'Gasolina', 'Fralda'].includes(i.cat)) essential += val; 
                else if(['Banco', 'Gastos por Fora', 'Empréstimo', 'Dívida', 'Contas'].includes(i.cat)) debt += val; 
                else lifestyle += val; 
            }
        });
        const pEss = total ? (essential / total) * 100 : 0; 
        const pDeb = total ? (debt / total) * 100 : 0; 
        const pLif = total ? (lifestyle / total) * 100 : 0;
        document.getElementById('pctEssencial').innerText = `${pEss.toFixed(0)}% (R$ ${essential.toLocaleString('pt-BR')})`; document.getElementById('barEssencial').style.width = `${pEss}%`;
        document.getElementById('pctEstilo').innerText = `${pLif.toFixed(0)}% (R$ ${lifestyle.toLocaleString('pt-BR')})`; document.getElementById('barEstilo').style.width = `${pLif}%`;
        document.getElementById('pctDividas').innerText = `${pDeb.toFixed(0)}% (R$ ${debt.toLocaleString('pt-BR')})`; document.getElementById('barDividas').style.width = `${pDeb}%`;
        const goal = Strategy.getGoal(); const goalDesc = StorageManager.load('capitalis_goal_desc');
        let projectedIncome = 0;
        const incomeTransactions = list.filter(i => i.date.startsWith(currentMonthStr) && i.amount > 0);
        if (incomeTransactions.length > 0) { projectedIncome = incomeTransactions.reduce((acc, i) => acc + i.amount, 0); } 
        else { projectedIncome = parseFloat(StorageManager.load('capitalis_fixed_salary') || 0); }
        const currentBalance = projectedIncome - total;
        document.getElementById('goalTarget').innerText = goal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}); 
        const btnText = document.getElementById('goalBtnText');
        if(btnText) { btnText.innerText = (goalDesc && goalDesc !== 'Meta geral') ? goalDesc : "Definir um novo objetivo"; }
        document.getElementById('goalCurrent').innerText = currentBalance.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        if(currentBalance < 0) { 
            document.getElementById('goalCurrent').style.color = 'var(--danger)'; 
            document.getElementById('goalBar').style.width = '0%'; 
            document.getElementById('goalMessage').innerText = "Você está no vermelho!"; 
        } else { 
            document.getElementById('goalCurrent').style.color = 'var(--success)'; 
            const pctGoal = (goal > 0) ? (currentBalance / goal) * 100 : 0; 
            document.getElementById('goalBar').style.width = `${Math.min(pctGoal, 100)}%`; 
            document.getElementById('goalMessage').innerText = goal > 0 && currentBalance >= goal ? "Sua meta foi alcançada, bora pra cima!" : "Em andamento"; 
        }
        const debts = Debts.getData(); const essentialEl = document.getElementById('essentialList'); const loanEl = document.getElementById('loanList'); essentialEl.innerHTML = ''; loanEl.innerHTML = '';
        const renderItem = (d, cssClass) => { 
            const isPaid = d.lastPaid === currentMonthStr;
            const isOverdue = !isPaid && d.dueDay < todayDay;
            let actionBtn = '';
            if (isPaid) { actionBtn = `<span style="font-size:0.75rem; background:var(--success); color:white; padding:4px 8px; border-radius:4px; font-weight:700;">PAGO</span>`; } 
            else if (isOverdue) { actionBtn = `<span class="badge-vencida">VENCIDA</span><button class="btn" style="padding:4px 8px; background:var(--warning); color:black; font-weight:700; font-size:0.75rem;" onclick="Debts.pay(${d.id})">PAGAR</button>`; } 
            else { actionBtn = `<button class="btn" style="padding:4px; color:var(--success);" onclick="Debts.pay(${d.id})"><i class="bi bi-check-lg"></i></button>`; }
            return `<div class="transaction-item ${cssClass}" style="${isPaid ? 'opacity:0.6;' : ''}"><div><div style="font-weight:500;">${Security.sanitize(d.name)}</div><div style="font-size:0.7rem; color:${isOverdue ? 'var(--danger)' : 'var(--text-muted)'};">${isOverdue ? 'Venceu dia ' : 'Vence dia '}${d.dueDay}</div></div><div style="display:flex; gap:10px; align-items:center;"><div class="blur-sensitive" style="color:var(--text-main); font-weight:700;">${d.amount > 0 ? 'R$ '+d.amount : 'A definir'}</div>${actionBtn}<button class="btn" style="padding:4px; color:var(--danger);" onclick="Debts.remove(${d.id})"><i class="bi bi-trash"></i></button></div></div>`; 
        };
        const essentials = debts.filter(d => d.type === 'essential').sort((a,b) => a.dueDay - b.dueDay); essentials.forEach(d => essentialEl.innerHTML += renderItem(d, 'card-essential'));
        const loans = debts.filter(d => d.type === 'loan').sort((a,b) => a.amount - b.amount); loans.forEach(d => loanEl.innerHTML += renderItem(d, 'card-loan'));
    }

    function renderFinance() {
        const list = Finance.getData(); const filter = document.getElementById('filterMonth').value; const search = document.getElementById('financeSearch').value.toLowerCase(); const el = document.getElementById('transactionList'); const catSummary = document.getElementById('categorySummary'); 
        const totalEl = document.getElementById('finTotal');
        const cardLabel = totalEl.previousElementSibling; if(cardLabel && cardLabel.classList.contains('card-label')) { cardLabel.innerText = "Saldo em Caixa (Mês)"; }
        el.innerHTML = '';
        let filtered = list; if(search) { filtered = list.filter(i => i.desc.toLowerCase().includes(search) || i.cat.toLowerCase().includes(search)); } else { filtered = list.filter(i => !filter || i.date.startsWith(filter)); }
        if(filtered.length === 0) { el.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">Nenhuma transação feita até o momento.</div>'; totalEl.innerText = 'R$ 0,00'; totalEl.style.color = 'var(--text-muted)'; catSummary.innerHTML = ''; return; }
        const displayList = search ? filtered : filtered.slice(0, 50);
        displayList.forEach(i => { const icon = getCategoryIcon(i.cat); const itemColor = i.amount >= 0 ? 'var(--success)' : 'var(--danger)'; const itemSign = i.amount >= 0 ? '+' : ''; el.innerHTML += `<div class="transaction-item"><div style="display:flex; align-items:center;"><div class="t-icon">${icon}</div><div><div style="font-weight:500; color:var(--text-main);">${Security.sanitize(i.desc)}</div><div style="font-size:0.7rem; color:var(--text-muted);">${i.cat} - ${i.date}</div></div></div><div class="blur-sensitive" style="color:${itemColor}; font-family:'JetBrains Mono'; font-weight:700;">${itemSign} ${Math.abs(i.amount).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</div></div>`; });
        const totalVal = filtered.reduce((a,b) => a + Number(b.amount), 0); totalEl.innerText = totalVal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        if (totalVal >= 0) { totalEl.style.color = 'var(--success)'; } else { totalEl.style.color = 'var(--danger)'; }
        if(!search) { const cats = {}; filtered.forEach(i => { if(i.amount < 0) { cats[i.cat] = (cats[i.cat] || 0) + Math.abs(i.amount); } }); const totalExpenses = Object.values(cats).reduce((a,b) => a+b, 0); const sortedCats = Object.entries(cats).sort((a,b) => b[1] - a[1]).slice(0, 3); if(totalExpenses > 0) { catSummary.innerHTML = sortedCats.map(c => { const pct = (c[1] / totalExpenses) * 100; return `<div class="cat-bar-container"><div class="cat-bar-header"><span>${c[0]}</span><span>${pct.toFixed(0)}%</span></div><div class="cat-bar-fill" style="width:${pct}%"></div></div>`; }).join(''); } else { catSummary.innerHTML = '<div style="font-size:0.8rem; color:var(--text-muted)">Sem gastos registrados.</div>'; } } else catSummary.innerHTML = '';
    }

    function renderLogs() { const el = document.getElementById('logsTerminal'); const logs = Logger.getLogs(); if(logs.length === 0) { el.innerHTML = '<div style="color:var(--text-muted); text-align:center; padding:20px;">Vazio.</div>'; return; } el.innerHTML = logs.map(l => `<div style="padding:10px; background: rgba(0,0,0,0.2); border-left: 3px solid var(--primary); border-radius: 4px; margin-bottom: 5px;"><div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span style="color:var(--primary); font-weight:bold;">[${l.action}]</span><span style="color:var(--text-muted); font-size:0.7rem;">${l.time}</span></div><div style="color:var(--text-main);">${Security.sanitize(l.desc)}</div><div style="color:var(--text-muted); font-size:0.7rem; margin-top:4px;">Usuário: ${l.user}</div></div>`).join(''); }
    function openMonthlyReport() { const filter = document.getElementById('filterMonth').value; const exps = Finance.getData().filter(i => !filter || i.date.startsWith(filter)).sort((a,b) => new Date(b.date) - new Date(a.date)); const total = exps.reduce((a,b) => a + b.amount, 0); document.getElementById('reportSummary').innerHTML = `<div><div style="font-size:0.7rem; color:var(--text-muted)">Valor disponível:</div><div style="font-weight:700; color:var(text-white)">${total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</div></div><div><div style="font-size:0.7rem; color:var(--text-muted)">Transações</div><div style="font-weight:700;">${exps.length}</div></div>`; const tbody = document.getElementById('reportTableBody'); tbody.innerHTML = ''; if(exps.length === 0) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:var(--text-muted)">Sem movimentações.</td></tr>'; else exps.forEach(i => { const d = i.date.split('-'); tbody.innerHTML += `<tr><td style="color:var(--text-muted); font-family:'JetBrains Mono'">${d[2]}/${d[1]}</td><td>${getCategoryIcon(i.cat)}</td><td>${i.cat}</td><td style="font-weight:500;">${Security.sanitize(i.desc)}</td><td class="blur-sensitive" style="color:var(--danger); font-weight:700; font-family:'JetBrains Mono'">- ${i.amount.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td><button class="btn" style="background:transparent; color:var(--text-muted); padding:4px;" onclick="Finance.remove(${i.id})"><i class="bi bi-trash"></i></button></td></tr>`; }); document.getElementById('reportModal').style.display = 'flex'; }
    function openNotifications() { document.getElementById('notifModal').style.display = 'flex'; }
    function saveDebt() { const name = document.getElementById('dName').value; const amount = document.getElementById('dAmount').value; const type = document.getElementById('dType').value; if(!name || !amount) return alert('Preencha nome e valor.'); Debts.add(name, amount, type, document.getElementById('dDue').value, type === 'loan' ? { current: document.getElementById('dCurrInst').value, total: document.getElementById('dTotalInst').value } : null, document.getElementById('dInstValue').value); }
    function openAddLoan() { document.getElementById('dType').value = 'loan'; toggleDebtFields(); document.getElementById('debtModal').style.display = 'flex'; }
    function toggleDebtFields() { document.getElementById('loanFields').style.display = document.getElementById('dType').value === 'loan' ? 'block' : 'none'; }
    function toggleAssetColor() {}
    function getCategoryIcon(categoria) {
        const cat = categoria ? categoria.toString() : '';
        const map = { 'Aluguel': '🏠', 'Casa': '🏡', 'Condomínio': '🏢', 'Luz': '💡', 'Energia': '⚡', 'Agua': '🚰', 'Água': '💧', 'Internet': '🌐', 'Wifi': '📶', 'Vivo': '📱', 'Celular': '📲', 'Tim': '📱', 'Claro': '📱', 'Mercado': '🛒', 'Feira': '🥬', 'Padaria': '🥖', 'Restaurante': '🍽️', 'Ifood': '🍔', 'Lanche': '🍕', 'Compras': '🛍️', 'Web': '📦', 'Amazon': '📦', 'Shopee': '🛍️', 'Gasolina': '⛽', 'Combustível': '⛽', 'Uber': '🚗', 'Transporte': '🚌', 'Mecânico': '🔧', 'Moto': '🏍️', 'Fralda': '👶', 'Escola': '🎒', 'Farmácia': '💊', 'Médico': '🩺', 'Banco': '🏦', 'Nubank': '🟪', 'Inter': '🟧', 'Taxa': '💸', 'Empréstimo': '🤝', 'Dívida': '📉', 'Cartão': '💳', 'Salário': '💰', 'Pagamento': '💵', 'Renda': '💎', 'Freela': '💻', 'Investimento': '🚀', 'Aporte': '📈', 'Reserva': '🛡️', 'Cripto': '₿' };
        if (map[cat]) return map[cat];
        const key = Object.keys(map).find(k => cat.includes(k));
        if (key) return map[key];
        return '🧾';
    }
    function switchView(v, el) { document.querySelectorAll('.view-section').forEach(x => x.classList.remove('active-view')); document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active')); document.getElementById('view-'+v).classList.add('active-view'); if(el) el.classList.add('active'); if(v==='income') renderIncome(); if(v==='finance') renderFinance(); if(v==='logs') renderLogs(); if(v==='assets') Assets.render(); if(v==='strategy') { renderStrategy(); Debts.checkNotifications(); } if(v==='invest') Invest.render(); if(window.innerWidth < 1100) toggleSidebar(); }
    function toggleSidebar() { const s = document.getElementById('mainSidebar'); s.classList.toggle('open'); document.getElementById('sidebarOverlay').style.display = s.classList.contains('open') ? 'block' : 'none'; }
    function openAddTransaction() { document.getElementById('transactionModal').style.display = 'flex'; }
    function openAddIncome() { document.getElementById('incDate').value = new Date().toISOString().slice(0,10); document.getElementById('incomeModal').style.display = 'flex'; }
    function openAddDebt() { document.getElementById('debtModal').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function logout() { if(confirm('Deseja sair?')) { sessionStorage.removeItem('capitalis_session'); window.location.href = 'index.html'; } }
    function saveTransaction() { 
        const desc = document.getElementById('tDesc').value; 
        let val = parseMoneyInput(document.getElementById('tAmount').value); 
        const cat = document.getElementById('tCat').value; 
        if (!desc || val === 0) return alert('Preencha a descrição e o valor.');
        if (val > 0) val = val * -1; 
        const saldoAtual = Assistant.getLiquidBalance();
        if (Math.abs(val) > saldoAtual) {
             return alert(`Operação cancelada!\n\nSeu saldo atual é de R$ ${saldoAtual.toLocaleString('pt-BR')}.\nVocê tentou gastar R$ ${Math.abs(val).toLocaleString('pt-BR')}.\n\nAdicione fundos (Renda/Salário) antes de gastar.`);
        }

        Finance.add(desc, val, cat);
        
        Feedback.trackAction();
    }

    window.addEventListener("beforeunload", () => StorageManager.emergencySave());
    window.onload = function() {
        const session = JSON.parse(sessionStorage.getItem('capitalis_session'));
        if(session) { document.getElementById('userNameDisplay').innerText = session.name; document.getElementById('userAvatarLetter').innerText = session.initial; }
        document.body.classList.add('privacy-mode');
        const toggleBtn = document.getElementById('themeToggle'); const privacyBtn = document.getElementById('privacyToggle');
        if (StorageManager.load('capitalis_theme') === 'light') document.body.classList.add('light-mode');
        toggleBtn.addEventListener('click', () => { document.body.classList.toggle('light-mode'); StorageManager.save('capitalis_theme', document.body.classList.contains('light-mode') ? 'light' : 'dark'); });
        privacyBtn.addEventListener('click', () => { document.body.classList.toggle('privacy-mode'); });
        document.getElementById('filterMonth').value = new Date().toISOString().slice(0, 7);
        
        renderFinance(); 
        Debts.checkNotifications(); 
        Assistant.init(); 
        Security.autoLock(); 

        Updates.init();
        
        const showedTutorial = Tutorial.init();
        if (!showedTutorial) {
            AdSystem.checkAccess();
        }
    };
    </script>
    </body>
    </html>
